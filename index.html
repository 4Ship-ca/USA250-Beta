<!-- 
USA250 v1.12-FINAL - Complete Shopify/Gelato Integration with SVG Fix
Last Updated: December 31, 2025

CRITICAL FIX: Background images now embedded as base64 before PNG conversion

Features:
- SVG background images embedded inline (no more blank uploads!)
- Complete variant mapping (20 variants)
- Robust error handling with size validation
- Cloudinary upload with folder organization
- Shopify cart integration with custom attributes
- Gelato fulfillment ready

Store: https://shop.4ship.ca
Backend: https://usa250-backend-gr41.vercel.app
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>America 250 - Design Your Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Libre+Baskerville:wght@700&family=Montserrat:wght@500;700;900&family=Cinzel:wght@700;900&family=Oswald:wght@700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --gold: #d4af37;
            --bg: #0a0a0a;
            --panel: #161616;
            --border: #333;
        }
        
        body {
            background: var(--bg);
            color: white;
            font-family: 'Montserrat', sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Mobile-first design */
        .container {
            width: 100%;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }
        
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #222;
            z-index: 1000;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), #ffd700);
            transition: width 0.3s ease;
            width: 25%;
        }
        
        .header {
            text-align: center;
            padding: 40px 20px 20px;
        }
        
        .logo {
            font-size: 28px;
            font-weight: 900;
            color: var(--gold);
            letter-spacing: 2px;
        }
        
        .step-indicator {
            margin-top: 10px;
            font-size: 14px;
            color: #888;
        }
        
        .style-section {
            margin: 30px 0;
        }
        
        .section-title {
            font-size: 18px;
            color: var(--gold);
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        .style-cards {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            height: 400px;
        }
        
        .style-card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: var(--panel);
            border-radius: 20px;
            border: 2px solid var(--border);
            overflow: hidden;
            transition: transform 0.3s ease, opacity 0.3s ease;
            cursor: pointer;
        }
        
        .style-card.active {
            transform: scale(1);
            opacity: 1;
            z-index: 10;
        }
        
        .style-card.prev {
            transform: translateX(-20px) scale(0.95);
            opacity: 0.5;
            z-index: 5;
        }
        
        .style-card.next {
            transform: translateX(20px) scale(0.95);
            opacity: 0.5;
            z-index: 5;
        }
        
        .card-mockup {
            width: 100%;
            height: 250px;
            background: #222;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
        }
        
        .card-content {
            padding: 20px;
            text-align: center;
        }
        
        .card-title {
            font-size: 22px;
            font-weight: 900;
            color: var(--gold);
            margin-bottom: 8px;
        }
        
        .card-description {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 15px;
        }
        
        .card-select-btn {
            background: var(--gold);
            color: black;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-weight: 900;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .card-select-btn:active {
            transform: scale(0.95);
        }
        
        .swipe-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .swipe-nav button {
            background: #333;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .swipe-nav button:active {
            background: var(--gold);
            color: black;
        }
        
        .location-section {
            margin: 30px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .locate-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 18px;
            border-radius: 15px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .locate-btn:active {
            transform: scale(0.98);
        }
        
        .or-divider {
            text-align: center;
            color: #666;
            margin: 15px 0;
            position: relative;
        }
        
        .or-divider::before,
        .or-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #333;
        }
        
        .or-divider::before { left: 0; }
        .or-divider::after { right: 0; }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-label {
            font-size: 12px;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            display: block;
        }
        
        .text-input {
            width: 100%;
            background: #1a1a1a;
            border: 2px solid #333;
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        .text-input:focus {
            border-color: var(--gold);
        }
        
        .char-counter {
            font-size: 11px;
            color: #666;
            text-align: right;
            margin-top: 5px;
        }
        
        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .suggestion-chip {
            background: #222;
            border: 1px solid #444;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .suggestion-chip:active {
            background: var(--gold);
            color: black;
            border-color: var(--gold);
        }
        
        .preview-section {
            margin: 30px 0;
            background: #1a1a1a;
            padding: 20px;
            border-radius: 20px;
            border: 2px solid #333;
        }
        
        .preview-title {
            font-size: 16px;
            color: var(--gold);
            text-align: center;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        .preview-canvas {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            aspect-ratio: 5/4;
            background: #000;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #previewSVG {
            width: 100%;
            height: auto;
            max-width: 100%;
        }
        
        .tweak-section {
            margin: 20px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .tweak-toggle {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .toggle-btn {
            background: transparent;
            border: 2px solid #444;
            padding: 12px 30px;
            border-radius: 25px;
            color: #aaa;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .toggle-btn.active {
            background: var(--gold);
            color: black;
            border-color: var(--gold);
        }
        
        .tweak-controls {
            display: none;
        }
        
        .tweak-controls.active {
            display: block;
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-label {
            font-size: 13px;
            color: #aaa;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .button-labels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 8px;
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }
        
        .button-grid-extended {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }
        
        .tweak-btn {
            aspect-ratio: 1;
            background: #222;
            border: 2px solid #444;
            border-radius: 15px;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        
        .tweak-btn:active {
            background: var(--gold);
            color: black;
            border-color: var(--gold);
            transform: scale(0.95);
        }
        
        .sticky-cta {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.95) 80%, transparent);
            padding: 20px;
            z-index: 100;
        }
        
        .mega-btn {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            background: linear-gradient(135deg, var(--gold) 0%, #ffd700 100%);
            border: none;
            padding: 20px;
            border-radius: 15px;
            color: black;
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
            transition: transform 0.2s;
            display: block;
        }
        
        .mega-btn:active {
            transform: scale(0.98);
        }
        
        .mega-btn:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
        }
        
        /* Desktop styles */
        @media (min-width: 768px) {
            .container {
                display: grid;
                grid-template-columns: 450px 1fr;
                gap: 30px;
                max-width: 1400px;
                margin: 0 auto;
                padding: 40px;
            }
            
            .left-panel {
                height: 90vh;
                overflow-y: auto;
                padding-right: 15px;
            }
            
            .left-panel::-webkit-scrollbar {
                width: 6px;
            }
            
            .left-panel::-webkit-scrollbar-thumb {
                background: var(--gold);
                border-radius: 10px;
            }
            
            .right-panel {
                position: sticky;
                top: 40px;
                height: fit-content;
            }
            
            .header {
                padding: 0 0 30px 0;
                text-align: left;
            }
            
            .logo {
                font-size: 32px;
            }
            
            .style-cards-desktop {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .style-cards {
                display: none;
            }
            
            .swipe-nav {
                display: none;
            }
            
            .style-card-desktop {
                background: var(--panel);
                border: 2px solid var(--border);
                border-radius: 15px;
                overflow: hidden;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .style-card-desktop:hover {
                border-color: var(--gold);
                transform: translateY(-5px);
            }
            
            .style-card-desktop.selected {
                border-color: var(--gold);
                box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
            }
            
            .card-mockup {
                height: 180px;
            }
            
            .card-content {
                padding: 15px;
            }
            
            .card-title {
                font-size: 18px;
            }
            
            .card-description {
                font-size: 13px;
            }
            
            .card-select-btn {
                padding: 10px 25px;
                font-size: 14px;
            }
            
            .preview-section {
                padding: 30px;
            }
            
            .preview-canvas {
                max-width: 600px;
            }
            
            .advanced-controls {
                display: block;
                margin-top: 20px;
                padding: 20px;
                background: #1a1a1a;
                border-radius: 15px;
            }
            
            .slider-group {
                margin-bottom: 15px;
            }
            
            .slider-label {
                display: flex;
                justify-content: space-between;
                font-size: 11px;
                color: #aaa;
                margin-bottom: 8px;
                text-transform: uppercase;
                letter-spacing: 1px;
            }
            
            .slider-value {
                color: var(--gold);
                font-family: monospace;
            }
            
            input[type="range"] {
                width: 100%;
                height: 6px;
                background: #333;
                border-radius: 5px;
                outline: none;
                -webkit-appearance: none;
            }
            
            input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 20px;
                height: 20px;
                background: var(--gold);
                border-radius: 50%;
                cursor: pointer;
            }
            
            input[type="range"]::-moz-range-thumb {
                width: 20px;
                height: 20px;
                background: var(--gold);
                border-radius: 50%;
                cursor: pointer;
                border: none;
            }
            
            .sticky-cta {
                position: static;
                background: transparent;
                padding: 20px 0;
            }
        }
        
        .hidden { display: none !important; }
        .loading { opacity: 0.5; pointer-events: none; }
        
        .product-selector {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
</div>

<div class="container">
    <div class="left-panel">
        <div class="header">
            <div class="logo">AMERICA 250 <span style="font-size: 12px; opacity: 0.5; font-weight: normal; margin-left: 8px;">v1.10</span></div>
            <div class="step-indicator" id="stepIndicator">Step 1 of 4: Pick Your Style</div>
        </div>
        
        <!-- STEP 1: Style Selection -->
        <div class="style-section" id="step1">
            <h2 class="section-title">Choose Your Style</h2>
            
            <div class="product-selector">
                <label class="input-label">Product Type</label>
                <select id="productSelect" onchange="changeProduct(this.value)" style="width: 100%; background: #1a1a1a; border: 2px solid #333; padding: 12px; border-radius: 10px; color: white; font-size: 14px;">
                    <option value="tee">üëï T-Shirt - $24.99</option>
                </select>
                <p style="font-size: 11px; color: #666; margin-top: 5px;">
                    Shape: <span id="shapeIndicator">Square (DTG)</span>
                </p>
            </div>
            
            <!-- Mobile: Swipeable Cards -->
            <div class="style-cards">
                <div class="style-card active" data-style="A">
                    <div class="card-mockup"></div>
                    <div class="card-content">
                        <div class="card-title">Heritage Style</div>
                        <div class="card-description">Classic Americana</div>
                        <button class="card-select-btn" onclick="selectStyle('A')">Select This Style</button>
                    </div>
                </div>
                <div class="style-card next" data-style="B">
                    <div class="card-mockup"></div>
                    <div class="card-content">
                        <div class="card-title">Midnight Style</div>
                        <div class="card-description">Bold & Modern</div>
                        <button class="card-select-btn" onclick="selectStyle('B')">Select This Style</button>
                    </div>
                </div>
                <div class="style-card" data-style="C">
                    <div class="card-mockup"></div>
                    <div class="card-content">
                        <div class="card-title">Retro Style</div>
                        <div class="card-description">Vintage Vibes</div>
                        <button class="card-select-btn" onclick="selectStyle('C')">Select This Style</button>
                    </div>
                </div>
                <div class="style-card" data-style="D">
                    <div class="card-mockup"></div>
                    <div class="card-content">
                        <div class="card-title">Outdoors Style</div>
                        <div class="card-description">Nature Inspired</div>
                        <button class="card-select-btn" onclick="selectStyle('D')">Select This Style</button>
                    </div>
                </div>
            </div>
            
            <div class="swipe-nav">
                <button onclick="previousCard()">‚Üê</button>
                <button onclick="nextCard()">‚Üí</button>
            </div>
            
            <!-- Desktop: Grid -->
            <div class="style-cards-desktop hidden">
                <div class="style-card-desktop" data-style="A" onclick="selectStyle('A')">
                    <div class="card-mockup"></div>
                    <div class="card-content">
                        <div class="card-title">Heritage</div>
                        <div class="card-description">Classic Americana</div>
                    </div>
                </div>
                <div class="style-card-desktop" data-style="B" onclick="selectStyle('B')">
                    <div class="card-mockup"></div>
                    <div class="card-content">
                        <div class="card-title">Midnight</div>
                        <div class="card-description">Bold & Modern</div>
                    </div>
                </div>
                <div class="style-card-desktop" data-style="C" onclick="selectStyle('C')">
                    <div class="card-mockup"></div>
                    <div class="card-content">
                        <div class="card-title">Retro</div>
                        <div class="card-description">Vintage Vibes</div>
                    </div>
                </div>
                <div class="style-card-desktop" data-style="D" onclick="selectStyle('D')">
                    <div class="card-mockup"></div>
                    <div class="card-content">
                        <div class="card-title">Outdoors</div>
                        <div class="card-description">Nature Inspired</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- STEP 2: Location -->
        <div class="location-section hidden" id="step2">
            <h2 class="section-title">Your Location</h2>
            
            <button class="locate-btn" onclick="useGeolocation()">
                <span>üìç</span>
                <span>Use My Location</span>
            </button>
            
            <div class="or-divider">OR</div>
            
            <div class="input-group">
                <label class="input-label">City & State</label>
                <input type="text" class="text-input" id="cityInput" maxlength="50" 
                       placeholder="MIAMI, FLORIDA" oninput="updateCity()">
                <div class="char-counter"><span id="cityCounter">50</span> characters remaining</div>
            </div>
            
            <div class="suggestions">
                <div class="suggestion-chip" onclick="useCity('MIAMI, FL')">Miami, FL</div>
                <div class="suggestion-chip" onclick="useCity('NEW YORK, NY')">New York, NY</div>
                <div class="suggestion-chip" onclick="useCity('LOS ANGELES, CA')">Los Angeles, CA</div>
                <div class="suggestion-chip" onclick="useCity('CHICAGO, IL')">Chicago, IL</div>
            </div>
        </div>
        
        <!-- STEP 3: Group Name -->
        <div class="location-section hidden" id="step3">
            <h2 class="section-title">Your Group</h2>
            
            <div class="input-group">
                <label class="input-label">Group or Family Name</label>
                <input type="text" class="text-input" id="groupInput" maxlength="35" 
                       placeholder="THE SMITH FAMILY" oninput="updateGroup()">
                <div class="char-counter"><span id="groupCounter">35</span> characters remaining</div>
            </div>
            
            <div class="suggestions">
                <div class="suggestion-chip" onclick="useGroup('THE SMITH FAMILY')">The Smith Family</div>
                <div class="suggestion-chip" onclick="useGroup('CLASS OF 2026')">Class of 2026</div>
                <div class="suggestion-chip" onclick="useGroup('TEAM USA')">Team USA</div>
                <div class="suggestion-chip" onclick="useGroup('AMERICA 250')">America 250</div>
            </div>
        </div>
        
        <!-- STEP 4: Tweak -->
        <div class="tweak-section hidden" id="step4">
            <div class="tweak-toggle">
                <button class="toggle-btn" id="tweakToggle" onclick="toggleTweak()">
                    ‚öôÔ∏è Fine-Tune Your Design
                </button>
            </div>
            
            <div class="tweak-controls" id="tweakControls">
                <div class="control-group">
                    <div class="control-label">City Text</div>
                    <div class="button-labels">
                        <span>Size</span>
                        <span>Position</span>
                        <span>Arc</span>
                    </div>
                    <div class="button-grid-extended">
                        <button class="tweak-btn" onclick="adjustCity('size', -1)">A-</button>
                        <button class="tweak-btn" onclick="adjustCity('size', 1)">A+</button>
                        <button class="tweak-btn" onclick="adjustCity('y', -1)">‚Üë</button>
                        <button class="tweak-btn" onclick="adjustCity('y', 1)">‚Üì</button>
                        <button class="tweak-btn" onclick="adjustCity('arc', -5)">‚åí-</button>
                        <button class="tweak-btn" onclick="adjustCity('arc', 5)">‚åí+</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-label">Group Text</div>
                    <div class="button-labels">
                        <span>Size</span>
                        <span>Position</span>
                        <span>Arc</span>
                    </div>
                    <div class="button-grid-extended">
                        <button class="tweak-btn" onclick="adjustGroup('size', -1)">A-</button>
                        <button class="tweak-btn" onclick="adjustGroup('size', 1)">A+</button>
                        <button class="tweak-btn" onclick="adjustGroup('y', -1)">‚Üë</button>
                        <button class="tweak-btn" onclick="adjustGroup('y', 1)">‚Üì</button>
                        <button class="tweak-btn" onclick="adjustGroup('arc', -5)">‚åí-</button>
                        <button class="tweak-btn" onclick="adjustGroup('arc', 5)">‚åí+</button>
                    </div>
                </div>
                
                <button class="toggle-btn" onclick="resetDesign()" style="width: 100%; margin-top: 15px;">
                    üîÑ Reset to Auto
                </button>
            </div>
            
            <div class="advanced-controls hidden">
                <div class="slider-group">
                    <div class="slider-label">
                        <span>City Size</span>
                        <span class="slider-value" id="citySizeVal">10</span>
                    </div>
                    <input type="range" id="citySizeSlider" min="10" max="80" value="10" oninput="updateSlider('citySize', this.value)">
                </div>
                
                <div class="slider-group">
                    <div class="slider-label">
                        <span>City Y-Position</span>
                        <span class="slider-value" id="cityYVal">223</span>
                    </div>
                    <input type="range" id="cityYSlider" min="0" max="300" value="223" oninput="updateSlider('cityY', this.value)">
                </div>
                
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Group Size</span>
                        <span class="slider-value" id="groupSizeVal">8</span>
                    </div>
                    <input type="range" id="groupSizeSlider" min="8" max="50" value="8" oninput="updateSlider('groupSize', this.value)">
                </div>
                
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Group Y-Position</span>
                        <span class="slider-value" id="groupYVal">282</span>
                    </div>
                    <input type="range" id="groupYSlider" min="50" max="400" value="282" oninput="updateSlider('groupY', this.value)">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right Panel: Preview -->
    <div class="right-panel">
        <div class="preview-section">
            <div class="preview-title">Live Preview</div>
            <div class="preview-canvas">
                <svg id="previewSVG" viewBox="0 0 500 400" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <path id="pathTop" d="M 20,223 A 230,45 0 0,1 480,223" />
                        <path id="pathMid" d="M 20,282 A 230,65 0 0,1 480,282" />
                    </defs>
                    <image id="bgImage" x="0" y="0" width="500" height="400" preserveAspectRatio="xMidYMid meet" />
                    <text id="cityText" text-anchor="middle" fill="#F2E8C9" font-family="Libre Baskerville" font-weight="700" font-size="10">
                        <textPath href="#pathTop" startOffset="50%"></textPath>
                    </text>
                    <text id="groupText" text-anchor="middle" fill="#F2E8C9" font-family="Libre Baskerville" font-weight="700" font-size="8">
                        <textPath href="#pathMid" startOffset="50%"></textPath>
                    </text>
                </svg>
            </div>
        </div>
    </div>
</div>

<div class="sticky-cta">
    <button class="mega-btn" id="ctaButton" onclick="handleCheckout()" disabled>
        Select a Style to Continue
    </button>
</div>

<script>
    // State management
    let currentStep = 1;
    let currentCardIndex = 0;
    let selectedStyle = null;
    let selectedProduct = 'tee';
    let selectedColor = 'White';
    let selectedSize = 'L';
    let cityText = '';
    let groupText = '';
    let baselineArch = { cityArch: 64, groupArch: 64, cityTrack: 0, groupTrack: 2 };
    
    const PRODUCTS = {
        'tee': { shape: 'Sq', name: 'T-Shirt', price: 24.99, category: 'Apparel' }
    };
    
    const STYLES = {
        A: { font: "Libre Baskerville", color: "#F2E8C9", weight: "700", name: "Heritage" },
        B: { font: "Anton", color: "#E6DCC8", weight: "400", name: "Midnight" },
        C: { font: "Oswald", color: "#A61A26", weight: "700", name: "Retro" },
        D: { font: "Cinzel", color: "#0F2A1B", weight: "700", name: "Outdoors" }
    };
    
    // Shopify Integration
    const SHOPIFY_CONFIG = {
        backendUrl: 'https://usa250-backend.vercel.app/api/create-draft-order',
        productId: '8581802721430'
    };
    
    const VARIANT_MAP = {
        'Navy-M': '46056445444246',
        'Navy-L': '46056445477014',
        'Navy-XL': '46056445509782',
        'Navy-2XL': '46056445542550',
        'Navy-S': '46056445575318',
        'Black-M': '46056445608086',
        'Black-L': '46056445640854',
        'Black-XL': '46056445673622',
        'Black-2XL': '46056445706390',
        'Black-S': '46056445739158',
        'Gray-M': '46056445771926',
        'Gray-L': '46056445804694',
        'Gray-XL': '46056445837462',
        'Gray-2XL': '46056445870230',
        'Gray-S': '46056445902998',
        'White-M': '46056445935766',
        'White-L': '46056445968534',
        'White-XL': '46056446001302',
        'White-2XL': '46056446034070',
        'White-S': '46056446066838'
    };
    
    function getMockupUrl(style, product) {
        const shape = PRODUCTS[product].shape;
        return `mockups/Style_${style}_${shape}_${product}.png`;
    }
    
    function loadMockup(imgElement, style, product) {
        const primaryUrl = getMockupUrl(style, product);
        imgElement.src = primaryUrl;
        imgElement.alt = `${STYLES[style].name} - ${PRODUCTS[product].name}`;
        
        imgElement.onerror = () => {
            imgElement.src = 'mockups/placeholder.png';
            imgElement.onerror = () => {
                const colors = { A: '#1a3a5c', B: '#0a0a0a', C: '#5c1a1a', D: '#1a3a1a' };
                imgElement.style.background = colors[style] || '#333';
                imgElement.alt = `${STYLES[style].name} Style Preview`;
            };
        };
    }
    
    function initializeMockups() {
        const styles = ['A', 'B', 'C', 'D'];
        
        styles.forEach(style => {
            const mobileCard = document.querySelector(`.style-card[data-style="${style}"] .card-mockup`);
            if (mobileCard) {
                const img = document.createElement('img');
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                loadMockup(img, style, selectedProduct);
                mobileCard.innerHTML = '';
                mobileCard.appendChild(img);
            }
            
            const desktopCard = document.querySelector(`.style-card-desktop[data-style="${style}"] .card-mockup`);
            if (desktopCard) {
                const img = document.createElement('img');
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                loadMockup(img, style, selectedProduct);
                desktopCard.innerHTML = '';
                desktopCard.appendChild(img);
            }
        });
    }
    
    function nextCard() {
        const cards = document.querySelectorAll('.style-card');
        cards[currentCardIndex].classList.remove('active');
        cards[currentCardIndex].classList.add('prev');
        
        currentCardIndex = (currentCardIndex + 1) % cards.length;
        
        cards[currentCardIndex].classList.remove('prev', 'next');
        cards[currentCardIndex].classList.add('active');
        
        if (currentCardIndex < cards.length - 1) {
            cards[currentCardIndex + 1].classList.remove('prev');
            cards[currentCardIndex + 1].classList.add('next');
        }
    }
    
    function previousCard() {
        const cards = document.querySelectorAll('.style-card');
        cards[currentCardIndex].classList.remove('active');
        cards[currentCardIndex].classList.add('next');
        
        currentCardIndex = (currentCardIndex - 1 + cards.length) % cards.length;
        
        cards[currentCardIndex].classList.remove('prev', 'next');
        cards[currentCardIndex].classList.add('active');
    }
    
    function changeProduct(productKey) {
        selectedProduct = productKey;
        const product = PRODUCTS[productKey];
        const shapeText = product.shape === 'Sq' ? 'Square (DTG)' : 'Oval (Merch)';
        document.getElementById('shapeIndicator').textContent = shapeText;
        initializeMockups();
        if (selectedStyle) {
            loadTemplate(selectedStyle, product.shape);
        }
    }
    
    function selectStyle(style) {
        selectedStyle = style;
        
        document.querySelectorAll('.style-card-desktop').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelector(`[data-style="${style}"]`)?.classList.add('selected');
        
        const styleConfig = STYLES[style];
        document.getElementById('cityText').setAttribute('fill', styleConfig.color);
        document.getElementById('cityText').setAttribute('font-family', styleConfig.font);
        document.getElementById('groupText').setAttribute('fill', styleConfig.color);
        document.getElementById('groupText').setAttribute('font-family', styleConfig.font);
        
        const shape = PRODUCTS[selectedProduct].shape;
        loadTemplate(style, shape);
        
        currentStep = 2;
        showStep(2);
    }
    
    async function loadTemplate(style, shape) {
        try {
            const templatePath = `templates/Style_${style}_${shape}.svg`;
            const jsonPath = `templates/Style_${style}_${shape}.json`;
            
            const bgImage = document.getElementById('bgImage');
            if (bgImage) {
                bgImage.setAttribute('href', templatePath);
            }
            
            const jsonResponse = await fetch(jsonPath);
            let baseline = null;
            if (jsonResponse.ok) {
                baseline = await jsonResponse.json();
            }
            
            if (baseline && baseline.sliders) {
                const s = baseline.sliders;
                if (s.cityY) document.getElementById('cityYSlider').value = s.cityY;
                if (s.citySize) document.getElementById('citySizeSlider').value = s.citySize;
                if (s.groupY) document.getElementById('groupYSlider').value = s.groupY;
                if (s.gSize) document.getElementById('groupSizeSlider').value = s.gSize;
                
                baselineArch.cityArch = parseInt(s.archIntensity) || 64;
                baselineArch.groupArch = parseInt(s.gArch) || 64;
                baselineArch.cityTrack = parseInt(s.cityTrack) || 0;
                baselineArch.groupTrack = parseInt(s.gTrack) || 2;
            }
            
            updatePreview();
            
        } catch (error) {
            console.error('Template load failed:', error);
            updatePreview();
        }
    }
    
    function useGeolocation() {
        useCity('BRANTFORD, ONTARIO');
    }
    
    function useCity(city) {
        document.getElementById('cityInput').value = city;
        updateCity();
        setTimeout(() => {
            currentStep = 3;
            showStep(3);
        }, 300);
    }
    
    function updateCity() {
        cityText = document.getElementById('cityInput').value.toUpperCase();
        const remaining = 50 - cityText.length;
        document.getElementById('cityCounter').textContent = remaining;
        updatePreview();
        if (cityText.length > 0 && currentStep === 2) {
            updateCTA('Continue ‚Üí');
        }
    }
    
    function useGroup(group) {
        document.getElementById('groupInput').value = group;
        updateGroup();
        setTimeout(() => {
            currentStep = 4;
            showStep(4);
        }, 300);
    }
    
    function updateGroup() {
        groupText = document.getElementById('groupInput').value.toUpperCase();
        const remaining = 35 - groupText.length;
        document.getElementById('groupCounter').textContent = remaining;
        updatePreview();
        if (groupText.length > 0 && currentStep === 3) {
            updateCTA('Continue ‚Üí');
        }
    }
    
    function toggleTweak() {
        const controls = document.getElementById('tweakControls');
        const btn = document.getElementById('tweakToggle');
        controls.classList.toggle('active');
        btn.classList.toggle('active');
    }
    
    function adjustCity(property, delta) {
        if (property === 'size') {
            let current = parseInt(document.getElementById('citySizeSlider')?.value || 10);
            current = Math.max(10, Math.min(80, current + delta));
            updateSlider('citySize', current);
        } else if (property === 'y') {
            let current = parseInt(document.getElementById('cityYSlider')?.value || 223);
            current = Math.max(0, Math.min(300, current + (delta * 5)));
            updateSlider('cityY', current);
        } else if (property === 'arc') {
            baselineArch.cityArch = Math.max(10, Math.min(450, baselineArch.cityArch + delta));
            updatePreview();
        }
    }
    
    function adjustGroup(property, delta) {
        if (property === 'size') {
            let current = parseInt(document.getElementById('groupSizeSlider')?.value || 8);
            current = Math.max(8, Math.min(50, current + delta));
            updateSlider('groupSize', current);
        } else if (property === 'y') {
            let current = parseInt(document.getElementById('groupYSlider')?.value || 282);
            current = Math.max(50, Math.min(400, current + (delta * 5)));
            updateSlider('groupY', current);
        } else if (property === 'arc') {
            baselineArch.groupArch = Math.max(10, Math.min(450, baselineArch.groupArch + delta));
            updatePreview();
        }
    }
    
    function updateSlider(property, value) {
        const slider = document.getElementById(property + 'Slider');
        const valueDisplay = document.getElementById(property + 'Val');
        if (slider) slider.value = value;
        if (valueDisplay) valueDisplay.textContent = value;
        updatePreview();
    }
    
    function resetDesign() {
        updateSlider('citySize', 10);
        updateSlider('cityY', 223);
        updateSlider('groupSize', 8);
        updateSlider('groupY', 282);
    }
    
    function formatText(text, baseSize) {
        if (!text) return '';
        const words = text.split(/\s+/).filter(w => w.length > 0);
        return words.map((word, i) => {
            const dx = i > 0 ? `dx="${baseSize * 0.45}"` : '';
            if (/^\d+$/.test(word)) {
                return `<tspan ${dx} font-size="${baseSize * 1.35}">${word}</tspan>`;
            } else {
                return `<tspan ${dx} font-size="${baseSize * 1.35}">${word[0]}</tspan><tspan font-size="${baseSize}">${word.slice(1)}</tspan>`;
            }
        }).join('');
    }
    
    function updatePreview() {
        const style = STYLES[selectedStyle];
        const citySize = parseInt(document.getElementById('citySizeSlider')?.value || 10);
        const cityY = parseInt(document.getElementById('cityYSlider')?.value || 223);
        const groupSize = parseInt(document.getElementById('groupSizeSlider')?.value || 8);
        const groupY = parseInt(document.getElementById('groupYSlider')?.value || 282);
        
        const pathTop = document.getElementById('pathTop');
        const pathMid = document.getElementById('pathMid');
        
        if (pathTop && pathMid) {
            pathTop.setAttribute('d', `M 20,${cityY} A 230,${baselineArch.cityArch} 0 0,1 480,${cityY}`);
            pathMid.setAttribute('d', `M 20,${groupY} A 230,${baselineArch.groupArch} 0 0,1 480,${groupY}`);
        }
        
        const cityContainer = document.querySelector('#cityText');
        const groupContainer = document.querySelector('#groupText');
        
        if (cityContainer && style) {
            cityContainer.setAttribute('fill', style.color);
            cityContainer.setAttribute('font-family', `"${style.font}"`);
            cityContainer.setAttribute('font-weight', style.weight);
            cityContainer.style.fontFamily = `"${style.font}", sans-serif`;
            cityContainer.style.letterSpacing = baselineArch.cityTrack + "px";
            cityContainer.setAttribute('font-size', citySize);
            
            const cityTextPath = cityContainer.querySelector('textPath');
            if (cityTextPath) {
                cityTextPath.innerHTML = formatText(cityText, citySize);
            }
        }
        
        if (groupContainer && style) {
            groupContainer.setAttribute('fill', style.color);
            groupContainer.setAttribute('font-family', `"${style.font}"`);
            groupContainer.setAttribute('font-weight', style.weight);
            groupContainer.style.fontFamily = `"${style.font}", sans-serif`;
            groupContainer.style.letterSpacing = baselineArch.groupTrack + "px";
            groupContainer.setAttribute('font-size', groupSize);
            
            const groupTextPath = groupContainer.querySelector('textPath');
            if (groupTextPath) {
                groupTextPath.innerHTML = formatText(groupText, groupSize);
            }
        }
    }
    
    function showStep(step) {
        for (let i = 1; i <= 4; i++) {
            document.getElementById(`step${i}`)?.classList.add('hidden');
        }
        document.getElementById(`step${step}`)?.classList.remove('hidden');
        updateProgress();
        updateStepIndicator();
        updateCTA();
    }
    
    function updateProgress() {
        const progress = (currentStep / 4) * 100;
        document.getElementById('progressFill').style.width = progress + '%';
    }
    
    function updateStepIndicator() {
        const steps = ['Pick Your Style', 'Your Location', 'Your Group', 'Review & Checkout'];
        document.getElementById('stepIndicator').textContent = `Step ${currentStep} of 4: ${steps[currentStep - 1]}`;
    }
    
    function updateCTA(text) {
        const btn = document.getElementById('ctaButton');
        
        if (text) {
            btn.textContent = text;
            btn.disabled = false;
        } else if (currentStep === 1) {
            btn.textContent = selectedStyle ? 'Continue ‚Üí' : 'Select a Style to Continue';
            btn.disabled = !selectedStyle;
        } else if (currentStep === 2) {
            btn.textContent = cityText ? 'Continue ‚Üí' : 'Enter Your Location';
            btn.disabled = !cityText;
        } else if (currentStep === 3) {
            btn.textContent = groupText ? 'Continue ‚Üí' : 'Enter Your Group Name';
            btn.disabled = !groupText;
        } else if (currentStep === 4) {
            btn.textContent = 'Continue to Checkout ‚Üí';
            btn.disabled = false;
        }
    }
    
    async function generate9000pxPNG() {
        try {
            const canvas = document.createElement('canvas');
            const scale = 18;
            canvas.width = 500 * scale;
            canvas.height = 400 * scale;
            const ctx = canvas.getContext('2d');
            
            const style = STYLES[selectedStyle];
            const citySize = parseInt(document.getElementById('citySizeSlider')?.value || 10);
            const cityY = parseInt(document.getElementById('cityYSlider')?.value || 223);
            const groupSize = parseInt(document.getElementById('groupSizeSlider')?.value || 8);
            const groupY = parseInt(document.getElementById('groupYSlider')?.value || 282);
            
            const templatePath = `templates/Style_${selectedStyle}_${PRODUCTS[selectedProduct].shape}.svg`;
            const bgImage = await loadImage(templatePath);
            ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
            
            const svgNS = 'http://www.w3.org/2000/svg';
            const svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('width', canvas.width);
            svg.setAttribute('height', canvas.height);
            svg.setAttribute('viewBox', `0 0 ${canvas.width} ${canvas.height}`);
            
            const defs = document.createElementNS(svgNS, 'defs');
            const cityPath = document.createElementNS(svgNS, 'path');
            cityPath.setAttribute('id', 'exportCityPath');
            cityPath.setAttribute('d', `M ${20*scale},${cityY*scale} A ${230*scale},${baselineArch.cityArch*scale} 0 0,1 ${480*scale},${cityY*scale}`);
            const groupPath = document.createElementNS(svgNS, 'path');
            groupPath.setAttribute('id', 'exportGroupPath');
            groupPath.setAttribute('d', `M ${20*scale},${groupY*scale} A ${230*scale},${baselineArch.groupArch*scale} 0 0,1 ${480*scale},${groupY*scale}`);
            defs.appendChild(cityPath);
            defs.appendChild(groupPath);
            svg.appendChild(defs);
            
            const cityTextEl = document.createElementNS(svgNS, 'text');
            cityTextEl.setAttribute('text-anchor', 'middle');
            cityTextEl.setAttribute('fill', style.color);
            cityTextEl.setAttribute('font-family', style.font);
            cityTextEl.setAttribute('font-weight', style.weight);
            cityTextEl.setAttribute('font-size', citySize * scale);
            cityTextEl.style.letterSpacing = (baselineArch.cityTrack * scale) + 'px';
            const cityTextPath = document.createElementNS(svgNS, 'textPath');
            cityTextPath.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#exportCityPath');
            cityTextPath.setAttribute('startOffset', '50%');
            cityTextPath.innerHTML = formatText(cityText, citySize * scale);
            cityTextEl.appendChild(cityTextPath);
            svg.appendChild(cityTextEl);
            
            const groupTextEl = document.createElementNS(svgNS, 'text');
            groupTextEl.setAttribute('text-anchor', 'middle');
            groupTextEl.setAttribute('fill', style.color);
            groupTextEl.setAttribute('font-family', style.font);
            groupTextEl.setAttribute('font-weight', style.weight);
            groupTextEl.setAttribute('font-size', groupSize * scale);
            groupTextEl.style.letterSpacing = (baselineArch.groupTrack * scale) + 'px';
            const groupTextPath = document.createElementNS(svgNS, 'textPath');
            groupTextPath.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#exportGroupPath');
            groupTextPath.setAttribute('startOffset', '50%');
            groupTextPath.innerHTML = formatText(groupText, groupSize * scale);
            groupTextEl.appendChild(groupTextPath);
            svg.appendChild(groupTextEl);
            
            const svgData = new XMLSerializer().serializeToString(svg);
            const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
            const svgUrl = URL.createObjectURL(svgBlob);
            const textImage = await loadImage(svgUrl);
            ctx.drawImage(textImage, 0, 0);
            URL.revokeObjectURL(svgUrl);
            
            return new Promise((resolve) => {
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/png', 0.95);
            });
            
        } catch (error) {
            console.error('PNG generation failed:', error);
            return null;
        }
    }
    
    function loadImage(src) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = src;
        });
    }
    
    async function handleCheckout() {
        if (currentStep < 4) {
            currentStep++;
            showStep(currentStep);
        } else {
            try {
                const ctaBtn = document.getElementById('ctaButton');
                ctaBtn.disabled = true;
                ctaBtn.textContent = 'Generating design...';
                
                const pngBlob = await generate9000pxPNG();
                
                if (!pngBlob) {
                    throw new Error('PNG generation failed');
                }
                
                ctaBtn.textContent = 'Uploading design...';
                const timestamp = Date.now();
                const filename = `USA250_${selectedStyle}_${timestamp}`;
                
                const formData = new FormData();
                formData.append('file', pngBlob);
                formData.append('upload_preset', 'america250');
                formData.append('folder', 'america250');
                formData.append('public_id', filename);
                
                const cloudinaryResponse = await fetch(
                    `https://api.cloudinary.com/v1_1/dqab444bd/image/upload`,
                    {
                        method: 'POST',
                        body: formData
                    }
                );
                
                if (!cloudinaryResponse.ok) {
                    throw new Error('Cloudinary upload failed');
                }
                
                const cloudinaryData = await cloudinaryResponse.json();
                const designUrl = cloudinaryData.secure_url;
                
                console.log('‚úì Design uploaded:', designUrl);
                
                ctaBtn.textContent = 'Creating order...';
                
                const variantKey = `${selectedColor}-${selectedSize}`;
                const variantId = VARIANT_MAP[variantKey];
                
                if (!variantId) {
                    throw new Error(`No variant found for ${variantKey}`);
                }
                
                const orderResponse = await fetch(SHOPIFY_CONFIG.backendUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        designUrl: designUrl,
                        style: selectedStyle,
                        cityText: cityText,
                        groupText: groupText,
                        color: selectedColor,
                        size: selectedSize,
                        variantId: variantId
                    })
                });
                
                const orderData = await orderResponse.json();
                
                if (orderData.success) {
                    console.log('‚úì Draft order created:', orderData.draftOrderId);
                    window.location.href = orderData.checkoutUrl;
                } else {
                    throw new Error(orderData.error || 'Failed to create order');
                }
                
            } catch (error) {
                console.error('Checkout error:', error);
                alert('Something went wrong: ' + error.message);
                
                const ctaBtn = document.getElementById('ctaButton');
                ctaBtn.disabled = false;
                ctaBtn.textContent = 'Try Again';
            }
        }
    }
    
    function init() {
        updateProgress();
        updateStepIndicator();
        initializeMockups();
        
        if (window.innerWidth >= 768) {
            document.querySelector('.style-cards').classList.add('hidden');
            document.querySelector('.style-cards-desktop').classList.remove('hidden');
            document.querySelector('.advanced-controls').classList.remove('hidden');
        }
    }
    
    window.addEventListener('load', init);

    // Final checkout function for v1.11 frontend
// Add this to your index.html or main.js

async function handleCheckout() {
    // Validate selections
    if (!selectedStyle || !selectedProduct || !selectedColor || !selectedSize) {
        alert('Please select all options');
        return;
    }
    
    const checkoutBtn = document.getElementById('ctaButton');
    const originalText = checkoutBtn.textContent;
    checkoutBtn.textContent = 'Preparing design...';
    checkoutBtn.disabled = true;
    
    try {
        // VARIANT MAPPING
        const VARIANT_MAP = {
            'tee-black-s': { shopifyVariantId: '46057714417814', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_s_gco_black_gpr_4-0_gildan_64000' },
            'tee-black-m': { shopifyVariantId: '46057714548886', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_m_gco_black_gpr_4-0_gildan_64000' },
            'tee-black-l': { shopifyVariantId: '46057714516118', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_l_gco_black_gpr_4-0_gildan_64000' },
            'tee-black-xl': { shopifyVariantId: '46057714483350', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_xl_gco_black_gpr_4-0_gildan_64000' },
            'tee-black-2xl': { shopifyVariantId: '46057714450582', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_2xl_gco_black_gpr_4-0_gildan_64000' },
            'tee-white-s': { shopifyVariantId: '46057714581654', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_s_gco_white_gpr_4-0_gildan_64000' },
            'tee-white-m': { shopifyVariantId: '46057714712726', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_m_gco_white_gpr_4-0_gildan_64000' },
            'tee-white-l': { shopifyVariantId: '46057714679958', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_l_gco_white_gpr_4-0_gildan_64000' },
            'tee-white-xl': { shopifyVariantId: '46057714647190', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_xl_gco_white_gpr_4-0_gildan_64000' },
            'tee-white-2xl': { shopifyVariantId: '46057714614422', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_2xl_gco_white_gpr_4-0_gildan_64000' },
            'tee-navy-s': { shopifyVariantId: '46057714745494', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_s_gco_navy_gpr_4-0_gildan_64000' },
            'tee-navy-m': { shopifyVariantId: '46057714876566', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_m_gco_navy_gpr_4-0_gildan_64000' },
            'tee-navy-l': { shopifyVariantId: '46057714843798', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_l_gco_navy_gpr_4-0_gildan_64000' },
            'tee-navy-xl': { shopifyVariantId: '46057714811030', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_xl_gco_navy_gpr_4-0_gildan_64000' },
            'tee-navy-2xl': { shopifyVariantId: '46057714778262', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_2xl_gco_navy_gpr_4-0_gildan_64000' },
            'tee-gray-s': { shopifyVariantId: '46057714909334', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_s_gco_gray_gpr_4-0_gildan_64000' },
            'tee-gray-m': { shopifyVariantId: '46057715040406', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_m_gco_gray_gpr_4-0_gildan_64000' },
            'tee-gray-l': { shopifyVariantId: '46057715007638', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_l_gco_gray_gpr_4-0_gildan_64000' },
            'tee-gray-xl': { shopifyVariantId: '46057714974870', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_xl_gco_gray_gpr_4-0_gildan_64000' },
            'tee-gray-2xl': { shopifyVariantId: '46057714942102', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_2xl_gco_gray_gpr_4-0_gildan_64000' }
        };
        
        console.log('Starting checkout process...');
        
        // 1. Get SVG and clone it
        const svg = document.getElementById('previewSVG');
        if (!svg) {
            throw new Error('Design preview not found');
        }
        
        const svgClone = svg.cloneNode(true);
        
        // 2. CRITICAL FIX: Embed background image as base64
        checkoutBtn.textContent = 'Loading design elements...';
        
        const bgImage = svgClone.querySelector('#bgImage');
        if (bgImage && bgImage.href.baseVal) {
            const imageUrl = bgImage.href.baseVal;
            console.log('Loading background image:', imageUrl);
            
            // Load image and convert to base64
            const base64 = await new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    try {
                        // Draw to canvas to get base64
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        const dataUrl = canvas.toDataURL('image/png');
                        console.log('Background image converted to base64');
                        resolve(dataUrl);
                    } catch (err) {
                        reject(err);
                    }
                };
                
                img.onerror = () => reject(new Error('Failed to load background image'));
                img.src = imageUrl;
                
                setTimeout(() => reject(new Error('Background image load timeout')), 10000);
            });
            
            // Replace external URL with base64
            bgImage.setAttributeNS('http://www.w3.org/1999/xlink', 'href', base64);
            console.log('Background image embedded in SVG');
        }
        
        // Small delay for fonts
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // 3. Convert SVG (with embedded image) to PNG
        checkoutBtn.textContent = 'Converting design...';
        
        const svgData = new XMLSerializer().serializeToString(svgClone);
        const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(svgBlob);
        
        // Create image from SVG
        const img = new Image();
        
        const imageLoadPromise = new Promise((resolve, reject) => {
            img.onload = () => {
                console.log('SVG converted to image');
                resolve();
            };
            img.onerror = () => reject(new Error('Failed to convert SVG'));
            setTimeout(() => reject(new Error('SVG conversion timeout')), 10000);
        });
        
        img.src = url;
        await imageLoadPromise;
        
        // 4. Draw to high-res canvas
        const canvas = document.createElement('canvas');
        canvas.width = 9000;
        canvas.height = 7200;
        const ctx = canvas.getContext('2d');
        
        // Fill white background
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, 9000, 7200);
        
        // Calculate centered scaling
        const svgWidth = 500;
        const svgHeight = 400;
        const scale = Math.min(9000 / svgWidth, 7200 / svgHeight);
        const scaledWidth = svgWidth * scale;
        const scaledHeight = svgHeight * scale;
        const offsetX = (9000 - scaledWidth) / 2;
        const offsetY = (7200 - scaledHeight) / 2;
        
        // Draw SVG
        ctx.drawImage(img, offsetX, offsetY, scaledWidth, scaledHeight);
        
        URL.revokeObjectURL(url);
        
        console.log('Canvas created:', canvas.width, 'x', canvas.height);
        
        // 5. Convert to blob
        checkoutBtn.textContent = 'Generating PNG...';
        
        const blob = await new Promise((resolve, reject) => {
            canvas.toBlob((b) => {
                if (b) resolve(b);
                else reject(new Error('Failed to create PNG'));
            }, 'image/png', 1.0);
        });
        
        const sizeMB = (blob.size / 1024 / 1024).toFixed(2);
        console.log('PNG created, size:', sizeMB + 'MB');
        
        if (blob.size < 10000) {
            throw new Error('PNG file too small (' + sizeMB + 'MB) - design may not have rendered correctly');
        }
        
        // 6. Upload to Cloudinary
        checkoutBtn.textContent = 'Uploading design...';
        
        const formData = new FormData();
        formData.append('file', blob);
        formData.append('upload_preset', 'america250');
        formData.append('folder', 'usa250-orders');
        
        const cloudinaryResponse = await fetch(
            'https://api.cloudinary.com/v1_1/dqab444bd/image/upload',
            {
                method: 'POST',
                body: formData
            }
        );
        
        if (!cloudinaryResponse.ok) {
            const errorText = await cloudinaryResponse.text();
            throw new Error(`Upload failed: ${errorText}`);
        }
        
        const cloudinaryData = await cloudinaryResponse.json();
        const designUrl = cloudinaryData.secure_url;
        
        console.log('‚úì Design uploaded:', designUrl);
        console.log('‚úì Public ID:', cloudinaryData.public_id);
        
        // 7. Map variant
        const variantKey = `${selectedProduct}-${selectedColor}-${selectedSize}`.toLowerCase();
        const variant = VARIANT_MAP[variantKey];
        
        if (!variant) {
            throw new Error(`No variant found for: ${selectedProduct} / ${selectedColor} / ${selectedSize}`);
        }
        
        console.log('‚úì Variant found:', variantKey);
        
        // 8. Build Shopify URL
        checkoutBtn.textContent = 'Redirecting to checkout...';
        
        const shopifyUrl = new URL(`https://shop.4ship.ca/cart/${variant.shopifyVariantId}:1`);
        shopifyUrl.searchParams.append('attributes[design_url]', designUrl);
        shopifyUrl.searchParams.append('attributes[style]', selectedStyle);
        shopifyUrl.searchParams.append('attributes[city]', document.getElementById('cityInput').value || 'Custom Design');
        shopifyUrl.searchParams.append('attributes[group]', document.getElementById('groupInput').value || '');
        shopifyUrl.searchParams.append('attributes[gelato_product]', variant.gelatoUid);
        shopifyUrl.searchParams.append('attributes[gelato_template]', '45d4d937-e9bd-4ba3-83fe-1d7d965cce40');
        
        console.log('‚úì Redirecting to Shopify');
        
        // 9. Redirect
        window.location.href = shopifyUrl.toString();
        
    } catch (error) {
        console.error('‚úó Checkout error:', error);
        console.error('Stack:', error.stack);
        alert('Checkout failed: ' + error.message + '\n\nPlease try again or contact support.');
        checkoutBtn.textContent = originalText;
        checkoutBtn.disabled = false;
    }
}
</script>

</body>
</html>
