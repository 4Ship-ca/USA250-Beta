<!--
USA250 v1.14 - Multi-Step Navigation
Last Updated: January 1, 2026

NEW FEATURES:
- Back/Forward navigation buttons
- 3-step flow: Style ‚Üí Text ‚Üí Options
- Progress tracking
- State preservation between steps
- City/Group inputs hidden until step 2
- Color/Size selectors hidden until step 3

Step 1: Choose Style (card carousel)
Step 2: Customize Text (city + group inputs)
Step 3: Select Options (color + size)
-->
<!-- 
USA250 v1.14 - Complete Color/Size Selector Integration + SVG Fix
Last Updated: January 1, 2026 (v1.14 - Multi-step navigation with back/forward buttons, zoom behavior, inputs)

NEW FEATURES:
- Color selector (filtered by style)
- Size selector (S/M/L/XL/2XL)
- Zoom toggle (150% magnification)
- Smart color availability per style
- Fixed SVG-to-PNG with base64 embedding

Store: https://shop.4ship.ca
Backend: https://usa250-backend-gr41.vercel.app
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>America 250 - Design Your Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Libre+Baskerville:wght@700&family=Montserrat:wght@500;700;900&family=Cinzel:wght@700;900&family=Oswald:wght@700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --gold: #d4af37;
            --bg: #0a0a0a;
            --panel: #161616;
            --border: #333;
        }
        
        body {
            background: var(--bg);
            color: white;
            font-family: 'Montserrat', sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Mobile-first design */
        .container {
            width: 100%;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }
        
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #222;
            z-index: 1000;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), #ffd700);
            transition: width 0.3s ease;
            width: 25%;
        }
        
        .header {
            text-align: center;
            padding: 40px 20px 20px;
        }
        
        .logo {
            font-size: 28px;
            font-weight: 900;
            color: var(--gold);
            letter-spacing: 2px;
        }
        
        .step-indicator {
            margin-top: 10px;
            font-size: 14px;
            color: #888;
        }
        
        .style-section {
            margin: 30px 0;
        }
        
        .section-title {
            font-size: 18px;
            color: var(--gold);
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        .style-cards {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            height: 400px;
        }
        
        .style-card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: var(--panel);
            border-radius: 20px;
            border: 2px solid var(--border);
            overflow: hidden;
            transition: transform 0.3s ease, opacity 0.3s ease;
            cursor: pointer;
        }
        
        .style-card.active {
            transform: scale(1);
            opacity: 1;
            z-index: 10;
        }
        
        .style-card.prev {
            transform: translateX(-20px) scale(0.95);
            opacity: 0.5;
            z-index: 5;
        }
        
        .style-card.next {
            transform: translateX(20px) scale(0.95);
            opacity: 0.5;
            z-index: 5;
        }
        
        .card-mockup {
            width: 100%;
            height: 250px;
            background: #222;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
        }
        
        .card-content {
            padding: 20px;
            text-align: center;
        }
        
        .card-title {
            font-size: 22px;
            font-weight: 900;
            color: var(--gold);
            margin-bottom: 8px;
        }
        
        .card-description {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 15px;
        }
        
        .card-select-btn {
            background: var(--gold);
            color: black;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-weight: 900;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .card-select-btn:active {
            transform: scale(0.95);
        }
        
        .swipe-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .swipe-nav button {
            background: #333;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .swipe-nav button:active {
            background: var(--gold);
            color: black;
        }
        
        .location-section {
            margin: 30px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .locate-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 18px;
            border-radius: 15px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .locate-btn:active {
            transform: scale(0.98);
        }
        
        .or-divider {
            text-align: center;
            color: #666;
            margin: 15px 0;
            position: relative;
        }
        
        .or-divider::before,
        .or-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #333;
        }
        
        .or-divider::before { left: 0; }
        .or-divider::after { right: 0; }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-label {
            font-size: 12px;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            display: block;
        }
        
        .text-input {
            width: 100%;
            background: #1a1a1a;
            border: 2px solid #333;
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        .text-input:focus {
            border-color: var(--gold);
        }
        
        .char-counter {
            font-size: 11px;
            color: #666;
            text-align: right;
            margin-top: 5px;
        }
        
        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .suggestion-chip {
            background: #222;
            border: 1px solid #444;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .suggestion-chip:active {
            background: var(--gold);
            color: black;
            border-color: var(--gold);
        }
        
        .preview-section {
            margin: 30px 0;
            background: #1a1a1a;
            padding: 20px;
            border-radius: 20px;
            border: 2px solid #333;
        }
        
        .preview-title {
            font-size: 16px;
            color: var(--gold);
            text-align: center;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        .preview-canvas {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            aspect-ratio: 5/4;
            background: #000;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

/* Add this CSS after the existing preview-section styles */

/* FIXED CSS - Replace selector styles section */

.preview-title {
    font-size: 14px;
    color: var(--gold);
    margin-bottom: 15px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Preview wrapper - Fixed size container */
.preview-wrapper {
    position: relative;
    background: #f5f5f5;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    overflow: hidden; /* Crop when zoomed */
}

/* Preview canvas - zooms within wrapper */
.preview-canvas {
    width: 100%;
    transition: transform 0.3s ease;
    transform-origin: center center;
}

.preview-canvas.zoomed {
    transform: scale(1.5);
}

/* Zoom button - Bottom right corner */
.zoom-toggle {
    position: absolute;
    bottom: 15px;
    right: 15px;
    background: rgba(10, 10, 10, 0.8);
    border: 2px solid var(--border);
    border-radius: 8px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--gold);
    transition: all 0.3s ease;
    z-index: 10;
    backdrop-filter: blur(10px);
}

.zoom-toggle:hover {
    background: rgba(10, 10, 10, 0.95);
    border-color: var(--gold);
    transform: scale(1.1);
}

.zoom-toggle.active {
    background: var(--gold);
    color: var(--bg);
    border-color: var(--gold);
}

#previewSVG {
    display: block;
    width: 100%;
    height: auto;
}

/* SELECTOR SECTIONS */
.selector-section {
    margin-bottom: 20px;
}

.selector-label {
    font-size: 14px;
    color: var(--gold);
    margin-bottom: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* COLOR OPTIONS */
.color-options {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    min-height: 50px; /* Prevent layout shift when colors load */
}

.color-options:empty::after {
    content: 'Select a style to see available colors';
    color: #666;
    font-size: 13px;
    font-style: italic;
}

.color-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 3px solid var(--border);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    background: var(--panel);
}

.color-btn:hover {
    transform: scale(1.1);
    border-color: var(--gold);
}

.color-btn.active {
    border-color: var(--gold);
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.3);
}

.color-btn::before {
    content: '';
    position: absolute;
    inset: 4px;
    border-radius: 50%;
}

.color-btn[data-color="Black"]::before { background: #000; }
.color-btn[data-color="White"]::before { background: #fff; border: 1px solid #ddd; }
.color-btn[data-color="Navy"]::before { background: #001f3f; }
.color-btn[data-color="Gray"]::before { background: #808080; }

.color-btn .color-name {
    position: absolute;
    bottom: -25px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 11px;
    color: #888;
    white-space: nowrap;
}

.color-btn.active .color-name {
    color: var(--gold);
    font-weight: 700;
}

/* SIZE OPTIONS */
.size-options {
    display: flex;
    gap: 8px;
}

.size-btn {
    flex: 1;
    padding: 12px;
    background: var(--panel);
    border: 2px solid var(--border);
    border-radius: 8px;
    color: white;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.size-btn:hover {
    background: var(--border);
    border-color: var(--gold);
}

.size-btn.active {
    background: var(--gold);
    border-color: var(--gold);
    color: var(--bg);
}

/* Mobile responsive */
@media (max-width: 768px) {
    .color-options {
        justify-content: center;
    }
    
    .size-options {
        flex-wrap: wrap;
    }
    
    .size-btn {
        flex: 0 0 calc(33.333% - 6px);
    }
    
    .zoom-toggle {
        bottom: 10px;
        right: 10px;
        width: 36px;
        height: 36px;
    }
}


        
        #previewSVG {
            width: 100%;
            height: auto;
            max-width: 100%;
        }
        
        .tweak-section {
            margin: 20px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .tweak-toggle {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .toggle-btn {
            background: transparent;
            border: 2px solid #444;
            padding: 12px 30px;
            border-radius: 25px;
            color: #aaa;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .toggle-btn.active {
            background: var(--gold);
            color: black;
            border-color: var(--gold);
        }
        
        .tweak-controls {
            display: none;
        }
        
        .tweak-controls.active {
            display: block;
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-label {
            font-size: 13px;
            color: #aaa;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .button-labels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 8px;
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }
        
        .button-grid-extended {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }
        
        .tweak-btn {
            aspect-ratio: 1;
            background: #222;
            border: 2px solid #444;
            border-radius: 15px;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        
        .tweak-btn:active {
            background: var(--gold);
            color: black;
            border-color: var(--gold);
            transform: scale(0.95);
        }
        
        .sticky-cta {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.95) 80%, transparent);
            padding: 20px;
            z-index: 100;
        }
        
        .mega-btn {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            background: linear-gradient(135deg, var(--gold) 0%, #ffd700 100%);
            border: none;
            padding: 20px;
            border-radius: 15px;
            color: black;
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
            transition: transform 0.2s;
            display: block;
        }
        
        .mega-btn:active {
            transform: scale(0.98);
        }
        
        .mega-btn:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
        }
        
        /* Desktop styles */
        @media (min-width: 768px) {
            .container {
                display: grid;
                grid-template-columns: 450px 1fr;
                gap: 30px;
                max-width: 1400px;
                margin: 0 auto;
                padding: 40px;
            }
            
            .left-panel {
                height: 90vh;
                overflow-y: auto;
                padding-right: 15px;
            }
            
            .left-panel::-webkit-scrollbar {
                width: 6px;
            }
            
            .left-panel::-webkit-scrollbar-thumb {
                background: var(--gold);
                border-radius: 10px;
            }
            
            .right-panel {
                position: sticky;
                top: 40px;
                height: fit-content;
            }
            
            .header {
                padding: 0 0 30px 0;
                text-align: left;
            }
            
            .logo {
                font-size: 32px;
            }
            
            .style-cards-desktop {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .style-cards {
                display: none;
            }
            
            .swipe-nav {
                display: none;
            }
            
            .style-card-desktop {
                background: var(--panel);
                border: 2px solid var(--border);
                border-radius: 15px;
                overflow: hidden;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .style-card-desktop:hover {
                border-color: var(--gold);
                transform: translateY(-5px);
            }
            
            .style-card-desktop.selected {
                border-color: var(--gold);
                box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
            }
            
            .card-mockup {
                height: 180px;
            }
            
            .card-content {
                padding: 15px;
            }
            
            .card-title {
                font-size: 18px;
            }
            
            .card-description {
                font-size: 13px;
            }
            
            .card-select-btn {
                padding: 10px 25px;
                font-size: 14px;
            }
            
            .preview-section {
                padding: 30px;
            }
            
            .preview-canvas {
                max-width: 600px;
            }
            
            .advanced-controls {
                display: block;
                margin-top: 20px;
                padding: 20px;
                background: #1a1a1a;
                border-radius: 15px;
            }
            
            .slider-group {
                margin-bottom: 15px;
            }
            
            .slider-label {
                display: flex;
                justify-content: space-between;
                font-size: 11px;
                color: #aaa;
                margin-bottom: 8px;
                text-transform: uppercase;
                letter-spacing: 1px;
            }
            
            .slider-value {
                color: var(--gold);
                font-family: monospace;
            }
            
            input[type="range"] {
                width: 100%;
                height: 6px;
                background: #333;
                border-radius: 5px;
                outline: none;
                -webkit-appearance: none;
            }
            
            input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 20px;
                height: 20px;
                background: var(--gold);
                border-radius: 50%;
                cursor: pointer;
            }
            
            input[type="range"]::-moz-range-thumb {
                width: 20px;
                height: 20px;
                background: var(--gold);
                border-radius: 50%;
                cursor: pointer;
                border: none;
            }
            
            .sticky-cta {
                position: static;
                background: transparent;
                padding: 20px 0;
            }
        }
        
        .hidden { display: none !important; }
        .loading { opacity: 0.5; pointer-events: none; }
        
        .product-selector {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div class="progress-bar">
    <div class="progress-fill" id="progressFill">
<!-- ADD THIS AT THE BOTTOM OF THE CONTAINER (before closing </div>) -->

<div class="simple-navigation">
    <button class="simple-nav-btn back" id="navBackBtn" onclick="goBackSimple()">
        ‚Üê BACK
    </button>
    <button class="simple-nav-btn next" id="navNextBtn" onclick="goNextSimple()">
        NEXT ‚Üí
    </button>
</div>

<!-- ADD THIS CSS TO YOUR STYLES SECTION -->
<style>
/* Simple Navigation Buttons */
.simple-navigation {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(10, 10, 10, 0.95);
    backdrop-filter: blur(10px);
    border-top: 2px solid var(--border);
    padding: 20px;
    display: flex;
    justify-content: center;
    gap: 20px;
    z-index: 1000;
}

.simple-nav-btn {
    padding: 15px 40px;
    font-size: 16px;
    font-weight: 700;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
    border: 2px solid var(--border);
    font-family: 'Montserrat', sans-serif;
}

.simple-nav-btn.back {
    background: var(--panel);
    color: white;
}

.simple-nav-btn.back:hover {
    background: var(--border);
    border-color: var(--gold);
}

.simple-nav-btn.next {
    background: var(--gold);
    color: var(--bg);
    border-color: var(--gold);
}

.simple-nav-btn.next:hover {
    background: #ffd700;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
}

.simple-nav-btn.next:disabled {
    background: var(--border);
    color: #666;
    border-color: var(--border);
    cursor: not-allowed;
    opacity: 0.5;
}

/* Add padding to container for fixed nav */
.container {
    padding-bottom: 100px !important;
}

@media (max-width: 768px) {
    .simple-navigation {
        flex-direction: column;
        gap: 10px;
    }
    
    .simple-nav-btn {
        width: 100%;
    }
}
</style>

</div>
</div>

<div class="container">
    <div class="left-panel">
        <div class="header">
            <div class="logo">AMERICA 250 <span style="font-size: 12px; opacity: 0.5; font-weight: normal; margin-left: 8px;">v1.10</span></div>
            <div class="step-indicator" id="stepIndicator">Step 1 of 4: Pick Your Style</div>
        </div>
        
        <!-- STEP 1: Style Selection -->
        <div class="style-section" id="step1">
            <h2 class="section-title">Choose Your Style</h2>
            
            <div class="product-selector">
                <label class="input-label">Product Type</label>
                <select id="productSelect" onchange="changeProduct(this.value)" style="width: 100%; background: #1a1a1a; border: 2px solid #333; padding: 12px; border-radius: 10px; color: white; font-size: 14px;">
                    <option value="tee">üëï T-Shirt - $24.99</option>
                </select>
                <p style="font-size: 11px; color: #666; margin-top: 5px;">
                    Shape: <span id="shapeIndicator">Square (DTG)</span>
                </p>
            </div>
            
            <!-- Mobile: Swipeable Cards -->
            <div class="style-cards">
                <div class="style-card active" data-style="A">
                    <div class="card-mockup"></div>
                    <div class="card-content">
                        <div class="card-title">Heritage Style</div>
                        <div class="card-description">Classic Americana</div>
                        <button class="card-select-btn" onclick="selectStyle('A')">Select This Style</button>
                    </div>
                </div>
                <div class="style-card next" data-style="B">
                    <div class="card-mockup"></div>
                    <div class="card-content">
                        <div class="card-title">Midnight Style</div>
                        <div class="card-description">Bold & Modern</div>
                        <button class="card-select-btn" onclick="selectStyle('B')">Select This Style</button>
                    </div>
                </div>
                <div class="style-card" data-style="C">
                    <div class="card-mockup"></div>
                    <div class="card-content">
                        <div class="card-title">Retro Style</div>
                        <div class="card-description">Vintage Vibes</div>
                        <button class="card-select-btn" onclick="selectStyle('C')">Select This Style</button>
                    </div>
                </div>
                <div class="style-card" data-style="D">
                    <div class="card-mockup"></div>
                    <div class="card-content">
                        <div class="card-title">Outdoors Style</div>
                        <div class="card-description">Nature Inspired</div>
                        <button class="card-select-btn" onclick="selectStyle('D')">Select This Style</button>
                    </div>
                </div>
            </div>
            
            <div class="swipe-nav">
                <button onclick="previousCard()">‚Üê</button>
                <button onclick="nextCard()">‚Üí</button>
            </div>
            
            <!-- Desktop: Grid -->
            <div class="style-cards-desktop hidden">
                <div class="style-card-desktop" data-style="A" onclick="selectStyle('A')">
                    <div class="card-mockup"></div>
                    <div class="card-content">
                        <div class="card-title">Heritage</div>
                        <div class="card-description">Classic Americana</div>
                    </div>
                </div>
                <div class="style-card-desktop" data-style="B" onclick="selectStyle('B')">
                    <div class="card-mockup"></div>
                    <div class="card-content">
                        <div class="card-title">Midnight</div>
                        <div class="card-description">Bold & Modern</div>
                    </div>
                </div>
                <div class="style-card-desktop" data-style="C" onclick="selectStyle('C')">
                    <div class="card-mockup"></div>
                    <div class="card-content">
                        <div class="card-title">Retro</div>
                        <div class="card-description">Vintage Vibes</div>
                    </div>
                </div>
                <div class="style-card-desktop" data-style="D" onclick="selectStyle('D')">
                    <div class="card-mockup"></div>
                    <div class="card-content">
                        <div class="card-title">Outdoors</div>
                        <div class="card-description">Nature Inspired</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- STEP 2: Location -->
        <div class="location-section hidden" id="step2">
            <h2 class="section-title">Your Location</h2>
            
            <button class="locate-btn" onclick="useGeolocation()">
                <span>üìç</span>
                <span>Use My Location</span>
            </button>
            
            <div class="or-divider">OR</div>
            
            <div class="input-group">
                <label class="input-label">City & State</label>
                <input type="text" class="text-input" id="cityInput" maxlength="50" 
                       placeholder="MIAMI, FLORIDA" oninput="updateCity()">
                <div class="char-counter"><span id="cityCounter">50</span> characters remaining</div>
            </div>
            
            <div class="suggestions">
                <div class="suggestion-chip" onclick="useCity('MIAMI, FL')">Miami, FL</div>
                <div class="suggestion-chip" onclick="useCity('NEW YORK, NY')">New York, NY</div>
                <div class="suggestion-chip" onclick="useCity('LOS ANGELES, CA')">Los Angeles, CA</div>
                <div class="suggestion-chip" onclick="useCity('CHICAGO, IL')">Chicago, IL</div>
            </div>
        </div>
        
        <!-- STEP 3: Group Name -->
        <div class="location-section hidden" id="step3">
            <h2 class="section-title">Your Group</h2>
            
            <div class="input-group">
                <label class="input-label">Group or Family Name</label>
                <input type="text" class="text-input" id="groupInput" maxlength="35" 
                       placeholder="THE SMITH FAMILY" oninput="updateGroup()">
                <div class="char-counter"><span id="groupCounter">35</span> characters remaining</div>
            </div>
            
            <div class="suggestions">
                <div class="suggestion-chip" onclick="useGroup('THE SMITH FAMILY')">The Smith Family</div>
                <div class="suggestion-chip" onclick="useGroup('CLASS OF 2026')">Class of 2026</div>
                <div class="suggestion-chip" onclick="useGroup('TEAM USA')">Team USA</div>
                <div class="suggestion-chip" onclick="useGroup('AMERICA 250')">America 250</div>
            </div>
        </div>
        
        <!-- STEP 4: Tweak -->
        <div class="tweak-section hidden" id="step4">
            <div class="tweak-toggle">
                <button class="toggle-btn" id="tweakToggle" onclick="toggleTweak()">
                    ‚öôÔ∏è Fine-Tune Your Design
                </button>
            </div>
            
            <div class="tweak-controls" id="tweakControls">
                <div class="control-group">
                    <div class="control-label">City Text</div>
                    <div class="button-labels">
                        <span>Size</span>
                        <span>Position</span>
                        <span>Arc</span>
                    </div>
                    <div class="button-grid-extended">
                        <button class="tweak-btn" onclick="adjustCity('size', -1)">A-</button>
                        <button class="tweak-btn" onclick="adjustCity('size', 1)">A+</button>
                        <button class="tweak-btn" onclick="adjustCity('y', -1)">‚Üë</button>
                        <button class="tweak-btn" onclick="adjustCity('y', 1)">‚Üì</button>
                        <button class="tweak-btn" onclick="adjustCity('arc', -5)">‚åí-</button>
                        <button class="tweak-btn" onclick="adjustCity('arc', 5)">‚åí+</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-label">Group Text</div>
                    <div class="button-labels">
                        <span>Size</span>
                        <span>Position</span>
                        <span>Arc</span>
                    </div>
                    <div class="button-grid-extended">
                        <button class="tweak-btn" onclick="adjustGroup('size', -1)">A-</button>
                        <button class="tweak-btn" onclick="adjustGroup('size', 1)">A+</button>
                        <button class="tweak-btn" onclick="adjustGroup('y', -1)">‚Üë</button>
                        <button class="tweak-btn" onclick="adjustGroup('y', 1)">‚Üì</button>
                        <button class="tweak-btn" onclick="adjustGroup('arc', -5)">‚åí-</button>
                        <button class="tweak-btn" onclick="adjustGroup('arc', 5)">‚åí+</button>
                    </div>
                </div>
                
                <button class="toggle-btn" onclick="resetDesign()" style="width: 100%; margin-top: 15px;">
                    üîÑ Reset to Auto
                </button>
            </div>
            
            <div class="advanced-controls hidden">
                <div class="slider-group">
                    <div class="slider-label">
                        <span>City Size</span>
                        <span class="slider-value" id="citySizeVal">10</span>
                    </div>
                    <input type="range" id="citySizeSlider" min="10" max="80" value="10" oninput="updateSlider('citySize', this.value)">
                </div>
                
                <div class="slider-group">
                    <div class="slider-label">
                        <span>City Y-Position</span>
                        <span class="slider-value" id="cityYVal">223</span>
                    </div>
                    <input type="range" id="cityYSlider" min="0" max="300" value="223" oninput="updateSlider('cityY', this.value)">
                </div>
                
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Group Size</span>
                        <span class="slider-value" id="groupSizeVal">8</span>
                    </div>
                    <input type="range" id="groupSizeSlider" min="8" max="50" value="8" oninput="updateSlider('groupSize', this.value)">
                </div>
                
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Group Y-Position</span>
                        <span class="slider-value" id="groupYVal">282</span>
                    </div>
                    <input type="range" id="groupYSlider" min="50" max="400" value="282" oninput="updateSlider('groupY', this.value)">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right Panel: Preview -->
    <!-- Replace the right panel section (around line 860) with this -->

<!-- FIXED Right Panel - Replace entire right-panel div -->

<div class="right-panel">
    <div class="preview-section">
        <div class="preview-title">Live Preview</div>
        
        <div class="preview-wrapper">
            <div class="preview-canvas" id="previewCanvas">
                <svg id="previewSVG" viewBox="0 0 500 400" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <path id="pathTop" d="M 20,223 A 230,45 0 0,1 480,223" />
                        <path id="pathMid" d="M 20,282 A 230,65 0 0,1 480,282" />
                    </defs>
                    <image id="bgImage" x="0" y="0" width="500" height="400" preserveAspectRatio="xMidYMid meet" />
                    <text id="cityText" text-anchor="middle" fill="#F2E8C9" font-family="Libre Baskerville" font-weight="700" font-size="10">
                        <textPath href="#pathTop" startOffset="50%"></textPath>
                    </text>
                    <text id="groupText" text-anchor="middle" fill="#F2E8C9" font-family="Libre Baskerville" font-weight="700" font-size="8">
                        <textPath href="#pathMid" startOffset="50%"></textPath>
                    </text>
                </svg>
            </div>
            
            <button class="zoom-toggle" id="zoomToggle" onclick="toggleZoom()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                    <line x1="11" y1="8" x2="11" y2="14"/>
                    <line x1="8" y1="11" x2="14" y2="11"/>
                </svg>
            </button>
        </div>
        
        <!-- COLOR SELECTOR -->
        <div class="selector-section">
            <div class="selector-label">Color</div>
            <div class="color-options" id="colorOptions">
                <!-- Populated by updateColorOptions() when style selected -->
            </div>
        </div>
        
        <!-- SIZE SELECTOR -->
        <div class="selector-section">
            <div class="selector-label">Size</div>
            <div class="size-options">
                <button class="size-btn" data-size="S" onclick="selectSize('S')">S</button>
                <button class="size-btn" data-size="M" onclick="selectSize('M')">M</button>
                <button class="size-btn active" data-size="L" onclick="selectSize('L')">L</button>
                <button class="size-btn" data-size="XL" onclick="selectSize('XL')">XL</button>
                <button class="size-btn" data-size="2XL" onclick="selectSize('2XL')">2XL</button>
            </div>
        </div>
        
        <!-- TEXT INPUTS - NO PRESET VALUES -->
        <div class="input-section">
            <label for="cityInput">City, State</label>
            <input type="text" id="cityInput" placeholder="NEW YORK, NY" maxlength="30" value="">
        </div>
        
        <div class="input-section">
            <label for="groupInput">Group Name (Optional)</label>
            <input type="text" id="groupInput" placeholder="THE SMITH FAMILY" maxlength="30" value="">
        </div>
    </div>
</div>


</div>

<div class="sticky-cta">
    <button class="mega-btn" id="ctaButton" onclick="handleCheckout()" disabled>
        Select a Style to Continue
    </button>
</div>

<script>
    // State management
    let currentStep = 1;
    let currentCardIndex = 0;
    let selectedStyle = null;
    let selectedProduct = 'tee';
    let selectedColor = null;  // Set when style selected
    let selectedSize = 'L';
    let cityText = '';
    let groupText = '';
    let baselineArch = { cityArch: 64, groupArch: 64, cityTrack: 0, groupTrack: 2 };
    
    const PRODUCTS = {
        'tee': { shape: 'Sq', name: 'T-Shirt', price: 24.99, category: 'Apparel' }
    };

// Add these functions to your existing JavaScript section

// Color availability per style
// FIXED JAVASCRIPT - Add after variable declarations

// Color availability per style
const STYLE_COLORS = {
    'A': ['Black', 'White', 'Navy'],
    'B': ['Black', 'White', 'Navy', 'Gray'],
    'C': ['White', 'Navy', 'Gray'],
    'D': ['Black', 'White', 'Gray']
};

// Update color options based on selected style
function updateColorOptions() {
    const colorOptions = document.getElementById('colorOptions');
    
    if (!colorOptions) {
        console.error('Color options container not found');
        return;
    }
    
    if (!selectedStyle) {
        colorOptions.innerHTML = '';
        return;
    }
    
    const availableColors = STYLE_COLORS[selectedStyle] || ['Black', 'White', 'Navy', 'Gray'];
    
    console.log('Updating colors for style', selectedStyle, ':', availableColors);
    
    colorOptions.innerHTML = '';
    
    availableColors.forEach(color => {
        const btn = document.createElement('button');
        btn.className = 'color-btn';
        btn.setAttribute('data-color', color);
        btn.onclick = () => selectColor(color);
        
        const label = document.createElement('span');
        label.className = 'color-name';
        label.textContent = color;
        btn.appendChild(label);
        
        colorOptions.appendChild(btn);
    });
    
    // Auto-select first color if none selected or current not available
    if (!selectedColor || !availableColors.includes(selectedColor)) {
        selectColor(availableColors[0]);
    } else {
        // Update active state for current color
        const activeBtn = colorOptions.querySelector(`[data-color="${selectedColor}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
    }
}

// Select color
function selectColor(color) {
    selectedColor = color;
    
    console.log('Color selected:', color);
    
    // Update button states
    document.querySelectorAll('.color-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-color') === color);
    });
    
    // Update checkout button
    updateCheckoutButton();
}

// Select size
function selectSize(size) {
    selectedSize = size;
    
    console.log('Size selected:', size);
    
    // Update button states
    document.querySelectorAll('.size-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-size') === size);
    });
    
    // Update checkout button
    updateCheckoutButton();
}

// Zoom toggle - Fixed to crop/scale within frame
let isZoomed = false;

function toggleZoom() {
    const canvas = document.getElementById('previewCanvas');
    const toggleBtn = document.getElementById('zoomToggle');
    
    if (!canvas || !toggleBtn) return;
    
    isZoomed = !isZoomed;
    
    if (isZoomed) {
        canvas.classList.add('zoomed');
        toggleBtn.classList.add('active');
        // Change icon to minus (zoom out)
        toggleBtn.querySelector('svg').innerHTML = `
            <circle cx="11" cy="11" r="8"/>
            <path d="M21 21l-4.35-4.35"/>
            <line x1="8" y1="11" x2="14" y2="11"/>
        `;
    } else {
        canvas.classList.remove('zoomed');
        toggleBtn.classList.remove('active');
        // Change icon to plus (zoom in)
        toggleBtn.querySelector('svg').innerHTML = `
            <circle cx="11" cy="11" r="8"/>
            <path d="M21 21l-4.35-4.35"/>
            <line x1="11" y1="8" x2="11" y2="14"/>
            <line x1="8" y1="11" x2="14" y2="11"/>
        `;
    }
}

// Update checkout button state
function updateCheckoutButton() {
    const btn = document.getElementById('ctaButton');
    if (!btn) return;
    
    if (selectedStyle && selectedColor && selectedSize) {
        btn.disabled = false;
        btn.textContent = 'CONTINUE TO CHECKOUT ‚Üí';
    } else {
        btn.disabled = true;
        if (!selectedStyle) {
            btn.textContent = 'Select a Style to Continue';
        } else if (!selectedColor) {
            btn.textContent = 'Select a Color to Continue';
        } else if (!selectedSize) {
            btn.textContent = 'Select a Size to Continue';
        }
    }
}

// CRITICAL: Update the selectCard function to call updateColorOptions
// Find your existing selectCard function and ADD these lines at the end:

/*
// COMPLETE FIXED selectCard function - Replace your existing one

function selectCard(index) {
    currentCardIndex = index;
    
    const cards = document.querySelectorAll('.style-card');
    cards.forEach((card, i) => {
        if (i === index) {
            card.style.transform = 'translateX(0) scale(1)';
            card.style.opacity = '1';
            card.style.zIndex = '10';
        } else if (i < index) {
            card.style.transform = 'translateX(-120%) scale(0.8)';
            card.style.opacity = '0';
            card.style.zIndex = '1';
        } else {
            card.style.transform = 'translateX(120%) scale(0.8)';
            card.style.opacity = '0';
            card.style.zIndex = '1';
        }
    });
    
    // Update style selection
    const card = cards[index];
    const style = card.getAttribute('data-style');
    selectedStyle = style;
    
    console.log('‚úì Style selected:', style);
    
    // Update design preview
    const templatePath = `templates/Style_${selectedStyle}_${PRODUCTS[selectedProduct].shape}.svg`;
    document.getElementById('bgImage').setAttributeNS('http://www.w3.org/1999/xlink', 'href', templatePath);
    updateText();
    
    // CRITICAL: Update color options for this style
    console.log('‚úì Updating color options...');
    updateColorOptions();
    
    // Enable/update checkout button
    updateCheckoutButton();
    
    console.log('‚úì selectCard complete');
}



*/


function selectCard(index) {
    currentCardIndex = index;
    
    const cards = document.querySelectorAll('.style-card');
    cards.forEach((card, i) => {
        if (i === index) {
            card.style.transform = 'translateX(0) scale(1)';
            card.style.opacity = '1';
            card.style.zIndex = '10';
        } else if (i < index) {
            card.style.transform = 'translateX(-120%) scale(0.8)';
            card.style.opacity = '0';
            card.style.zIndex = '1';
        } else {
            card.style.transform = 'translateX(120%) scale(0.8)';
            card.style.opacity = '0';
            card.style.zIndex = '1';
        }
    });
    
    // Update style selection
    const card = cards[index];
    const style = card.getAttribute('data-style');
    selectedStyle = style;
    
    console.log('Style selected:', style);
    
    // Update design preview
    const templatePath = `templates/Style_${selectedStyle}_${PRODUCTS[selectedProduct].shape}.svg`;
    document.getElementById('bgImage').setAttributeNS('http://www.w3.org/1999/xlink', 'href', templatePath);
    updateText();
    
    // UPDATE COLOR OPTIONS FOR THIS STYLE
    updateColorOptions();
    
    // Enable checkout button
    updateCheckoutButton();
}


// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set default size active state
    const defaultSize = document.querySelector('.size-btn[data-size="L"]');
    if (defaultSize) {
        defaultSize.classList.add('active');
    }
    
    // Initialize color options if style already selected
    if (selectedStyle) {
        updateColorOptions();
    }
    
    updateCheckoutButton();
});

    
    const STYLES = {
        A: { font: "Libre Baskerville", color: "#F2E8C9", weight: "700", name: "Heritage" },
        B: { font: "Anton", color: "#E6DCC8", weight: "400", name: "Midnight" },
        C: { font: "Oswald", color: "#A61A26", weight: "700", name: "Retro" },
        D: { font: "Cinzel", color: "#0F2A1B", weight: "700", name: "Outdoors" }
    };
    
    // Shopify Integration
    const SHOPIFY_CONFIG = {
        backendUrl: 'https://usa250-backend.vercel.app/api/create-draft-order',
        productId: '8581802721430'
    };
    
    const VARIANT_MAP = {
        'Navy-M': '46056445444246',
        'Navy-L': '46056445477014',
        'Navy-XL': '46056445509782',
        'Navy-2XL': '46056445542550',
        'Navy-S': '46056445575318',
        'Black-M': '46056445608086',
        'Black-L': '46056445640854',
        'Black-XL': '46056445673622',
        'Black-2XL': '46056445706390',
        'Black-S': '46056445739158',
        'Gray-M': '46056445771926',
        'Gray-L': '46056445804694',
        'Gray-XL': '46056445837462',
        'Gray-2XL': '46056445870230',
        'Gray-S': '46056445902998',
        'White-M': '46056445935766',
        'White-L': '46056445968534',
        'White-XL': '46056446001302',
        'White-2XL': '46056446034070',
        'White-S': '46056446066838'
    };
    
    function getMockupUrl(style, product) {
        const shape = PRODUCTS[product].shape;
        return `mockups/Style_${style}_${shape}_${product}.png`;
    }
    
    function loadMockup(imgElement, style, product) {
        const primaryUrl = getMockupUrl(style, product);
        imgElement.src = primaryUrl;
        imgElement.alt = `${STYLES[style].name} - ${PRODUCTS[product].name}`;
        
        imgElement.onerror = () => {
            imgElement.src = 'mockups/placeholder.png';
            imgElement.onerror = () => {
                const colors = { A: '#1a3a5c', B: '#0a0a0a', C: '#5c1a1a', D: '#1a3a1a' };
                imgElement.style.background = colors[style] || '#333';
                imgElement.alt = `${STYLES[style].name} Style Preview`;
            };
        };
    }
    
    function initializeMockups() {
        const styles = ['A', 'B', 'C', 'D'];
        
        styles.forEach(style => {
            const mobileCard = document.querySelector(`.style-card[data-style="${style}"] .card-mockup`);
            if (mobileCard) {
                const img = document.createElement('img');
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                loadMockup(img, style, selectedProduct);
                mobileCard.innerHTML = '';
                mobileCard.appendChild(img);
            }
            
            const desktopCard = document.querySelector(`.style-card-desktop[data-style="${style}"] .card-mockup`);
            if (desktopCard) {
                const img = document.createElement('img');
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                loadMockup(img, style, selectedProduct);
                desktopCard.innerHTML = '';
                desktopCard.appendChild(img);
            }
        });
    }
    
    function nextCard() {
        const cards = document.querySelectorAll('.style-card');
        cards[currentCardIndex].classList.remove('active');
        cards[currentCardIndex].classList.add('prev');
        
        currentCardIndex = (currentCardIndex + 1) % cards.length;
        
        cards[currentCardIndex].classList.remove('prev', 'next');
        cards[currentCardIndex].classList.add('active');
        
        if (currentCardIndex < cards.length - 1) {
            cards[currentCardIndex + 1].classList.remove('prev');
            cards[currentCardIndex + 1].classList.add('next');
        }
    }
    
    function previousCard() {
        const cards = document.querySelectorAll('.style-card');
        cards[currentCardIndex].classList.remove('active');
        cards[currentCardIndex].classList.add('next');
        
        currentCardIndex = (currentCardIndex - 1 + cards.length) % cards.length;
        
        cards[currentCardIndex].classList.remove('prev', 'next');
        cards[currentCardIndex].classList.add('active');
    }
    
    function changeProduct(productKey) {
        selectedProduct = productKey;
        const product = PRODUCTS[productKey];
        const shapeText = product.shape === 'Sq' ? 'Square (DTG)' : 'Oval (Merch)';
        document.getElementById('shapeIndicator').textContent = shapeText;
        initializeMockups();
        if (selectedStyle) {
            loadTemplate(selectedStyle, product.shape);
        }
    }
    
    function selectStyle(style) {
        selectedStyle = style;
        
        document.querySelectorAll('.style-card-desktop').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelector(`[data-style="${style}"]`)?.classList.add('selected');
        
        const styleConfig = STYLES[style];
        document.getElementById('cityText').setAttribute('fill', styleConfig.color);
        document.getElementById('cityText').setAttribute('font-family', styleConfig.font);
        document.getElementById('groupText').setAttribute('fill', styleConfig.color);
        document.getElementById('groupText').setAttribute('font-family', styleConfig.font);
        
        const shape = PRODUCTS[selectedProduct].shape;
        loadTemplate(style, shape);
        
        currentStep = 2;
        showStep(2);
    }
    
    async function loadTemplate(style, shape) {
        try {
            const templatePath = `templates/Style_${style}_${shape}.svg`;
            const jsonPath = `templates/Style_${style}_${shape}.json`;
            
            const bgImage = document.getElementById('bgImage');
            if (bgImage) {
                bgImage.setAttribute('href', templatePath);
            }
            
            const jsonResponse = await fetch(jsonPath);
            let baseline = null;
            if (jsonResponse.ok) {
                baseline = await jsonResponse.json();
            }
            
            if (baseline && baseline.sliders) {
                const s = baseline.sliders;
                if (s.cityY) document.getElementById('cityYSlider').value = s.cityY;
                if (s.citySize) document.getElementById('citySizeSlider').value = s.citySize;
                if (s.groupY) document.getElementById('groupYSlider').value = s.groupY;
                if (s.gSize) document.getElementById('groupSizeSlider').value = s.gSize;
                
                baselineArch.cityArch = parseInt(s.archIntensity) || 64;
                baselineArch.groupArch = parseInt(s.gArch) || 64;
                baselineArch.cityTrack = parseInt(s.cityTrack) || 0;
                baselineArch.groupTrack = parseInt(s.gTrack) || 2;
            }
            
            updatePreview();
            
        } catch (error) {
            console.error('Template load failed:', error);
            updatePreview();
        }
    }
    
    function useGeolocation() {
        useCity('BRANTFORD, ONTARIO');
    }
    
    function useCity(city) {
        document.getElementById('cityInput').value = city;
        updateCity();
        setTimeout(() => {
            currentStep = 3;
            showStep(3);
        }, 300);
    }
    
    function updateCity() {
        cityText = document.getElementById('cityInput').value.toUpperCase();
        const remaining = 50 - cityText.length;
        document.getElementById('cityCounter').textContent = remaining;
        updatePreview();
        if (cityText.length > 0 && currentStep === 2) {
            updateCTA('Continue ‚Üí');
        }
    }
    
    function useGroup(group) {
        document.getElementById('groupInput').value = group;
        updateGroup();
        setTimeout(() => {
            currentStep = 4;
            showStep(4);
        }, 300);
    }
    
    function updateGroup() {
        groupText = document.getElementById('groupInput').value.toUpperCase();
        const remaining = 35 - groupText.length;
        document.getElementById('groupCounter').textContent = remaining;
        updatePreview();
        if (groupText.length > 0 && currentStep === 3) {
            updateCTA('Continue ‚Üí');
        }
    }
    
    function toggleTweak() {
        const controls = document.getElementById('tweakControls');
        const btn = document.getElementById('tweakToggle');
        controls.classList.toggle('active');
        btn.classList.toggle('active');
    }
    
    function adjustCity(property, delta) {
        if (property === 'size') {
            let current = parseInt(document.getElementById('citySizeSlider')?.value || 10);
            current = Math.max(10, Math.min(80, current + delta));
            updateSlider('citySize', current);
        } else if (property === 'y') {
            let current = parseInt(document.getElementById('cityYSlider')?.value || 223);
            current = Math.max(0, Math.min(300, current + (delta * 5)));
            updateSlider('cityY', current);
        } else if (property === 'arc') {
            baselineArch.cityArch = Math.max(10, Math.min(450, baselineArch.cityArch + delta));
            updatePreview();
        }
    }
    
    function adjustGroup(property, delta) {
        if (property === 'size') {
            let current = parseInt(document.getElementById('groupSizeSlider')?.value || 8);
            current = Math.max(8, Math.min(50, current + delta));
            updateSlider('groupSize', current);
        } else if (property === 'y') {
            let current = parseInt(document.getElementById('groupYSlider')?.value || 282);
            current = Math.max(50, Math.min(400, current + (delta * 5)));
            updateSlider('groupY', current);
        } else if (property === 'arc') {
            baselineArch.groupArch = Math.max(10, Math.min(450, baselineArch.groupArch + delta));
            updatePreview();
        }
    }
    
    function updateSlider(property, value) {
        const slider = document.getElementById(property + 'Slider');
        const valueDisplay = document.getElementById(property + 'Val');
        if (slider) slider.value = value;
        if (valueDisplay) valueDisplay.textContent = value;
        updatePreview();
    }
    
    function resetDesign() {
        updateSlider('citySize', 10);
        updateSlider('cityY', 223);
        updateSlider('groupSize', 8);
        updateSlider('groupY', 282);
    }
    
    function formatText(text, baseSize) {
        if (!text) return '';
        const words = text.split(/\s+/).filter(w => w.length > 0);
        return words.map((word, i) => {
            const dx = i > 0 ? `dx="${baseSize * 0.45}"` : '';
            if (/^\d+$/.test(word)) {
                return `<tspan ${dx} font-size="${baseSize * 1.35}">${word}</tspan>`;
            } else {
                return `<tspan ${dx} font-size="${baseSize * 1.35}">${word[0]}</tspan><tspan font-size="${baseSize}">${word.slice(1)}</tspan>`;
            }
        }).join('');
    }
    
    function updatePreview() {
        const style = STYLES[selectedStyle];
        const citySize = parseInt(document.getElementById('citySizeSlider')?.value || 10);
        const cityY = parseInt(document.getElementById('cityYSlider')?.value || 223);
        const groupSize = parseInt(document.getElementById('groupSizeSlider')?.value || 8);
        const groupY = parseInt(document.getElementById('groupYSlider')?.value || 282);
        
        const pathTop = document.getElementById('pathTop');
        const pathMid = document.getElementById('pathMid');
        
        if (pathTop && pathMid) {
            pathTop.setAttribute('d', `M 20,${cityY} A 230,${baselineArch.cityArch} 0 0,1 480,${cityY}`);
            pathMid.setAttribute('d', `M 20,${groupY} A 230,${baselineArch.groupArch} 0 0,1 480,${groupY}`);
        }
        
        const cityContainer = document.querySelector('#cityText');
        const groupContainer = document.querySelector('#groupText');
        
        if (cityContainer && style) {
            cityContainer.setAttribute('fill', style.color);
            cityContainer.setAttribute('font-family', `"${style.font}"`);
            cityContainer.setAttribute('font-weight', style.weight);
            cityContainer.style.fontFamily = `"${style.font}", sans-serif`;
            cityContainer.style.letterSpacing = baselineArch.cityTrack + "px";
            cityContainer.setAttribute('font-size', citySize);
            
            const cityTextPath = cityContainer.querySelector('textPath');
            if (cityTextPath) {
                cityTextPath.innerHTML = formatText(cityText, citySize);
            }
        }
        
        if (groupContainer && style) {
            groupContainer.setAttribute('fill', style.color);
            groupContainer.setAttribute('font-family', `"${style.font}"`);
            groupContainer.setAttribute('font-weight', style.weight);
            groupContainer.style.fontFamily = `"${style.font}", sans-serif`;
            groupContainer.style.letterSpacing = baselineArch.groupTrack + "px";
            groupContainer.setAttribute('font-size', groupSize);
            
            const groupTextPath = groupContainer.querySelector('textPath');
            if (groupTextPath) {
                groupTextPath.innerHTML = formatText(groupText, groupSize);
            }
        }
    }
    
    function showStep(step) {
        for (let i = 1; i <= 4; i++) {
            document.getElementById(`step${i}`)?.classList.add('hidden');
        }
        document.getElementById(`step${step}`)?.classList.remove('hidden');
        updateProgress();
        updateStepIndicator();
        updateCTA();
    }
    
    function updateProgress() {
        const progress = (currentStep / 4) * 100;
        document.getElementById('progressFill').style.width = progress + '%';
    }
    
    function updateStepIndicator() {
        const steps = ['Pick Your Style', 'Your Location', 'Your Group', 'Review & Checkout'];
        document.getElementById('stepIndicator').textContent = `Step ${currentStep} of 4: ${steps[currentStep - 1]}`;
    }
    
    function updateCTA(text) {
        const btn = document.getElementById('ctaButton');
        
        if (text) {
            btn.textContent = text;
            btn.disabled = false;
        } else if (currentStep === 1) {
            btn.textContent = selectedStyle ? 'Continue ‚Üí' : 'Select a Style to Continue';
            btn.disabled = !selectedStyle;
        } else if (currentStep === 2) {
            btn.textContent = cityText ? 'Continue ‚Üí' : 'Enter Your Location';
            btn.disabled = !cityText;
        } else if (currentStep === 3) {
            btn.textContent = groupText ? 'Continue ‚Üí' : 'Enter Your Group Name';
            btn.disabled = !groupText;
        } else if (currentStep === 4) {
            btn.textContent = 'Continue to Checkout ‚Üí';
            btn.disabled = false;
        }
    }
    
    async function generate9000pxPNG() {
        try {
            const canvas = document.createElement('canvas');
            const scale = 18;
            canvas.width = 500 * scale;
            canvas.height = 400 * scale;
            const ctx = canvas.getContext('2d');
            
            const style = STYLES[selectedStyle];
            const citySize = parseInt(document.getElementById('citySizeSlider')?.value || 10);
            const cityY = parseInt(document.getElementById('cityYSlider')?.value || 223);
            const groupSize = parseInt(document.getElementById('groupSizeSlider')?.value || 8);
            const groupY = parseInt(document.getElementById('groupYSlider')?.value || 282);
            
            const templatePath = `templates/Style_${selectedStyle}_${PRODUCTS[selectedProduct].shape}.svg`;
            const bgImage = await loadImage(templatePath);
            ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
            
            const svgNS = 'http://www.w3.org/2000/svg';
            const svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('width', canvas.width);
            svg.setAttribute('height', canvas.height);
            svg.setAttribute('viewBox', `0 0 ${canvas.width} ${canvas.height}`);
            
            const defs = document.createElementNS(svgNS, 'defs');
            const cityPath = document.createElementNS(svgNS, 'path');
            cityPath.setAttribute('id', 'exportCityPath');
            cityPath.setAttribute('d', `M ${20*scale},${cityY*scale} A ${230*scale},${baselineArch.cityArch*scale} 0 0,1 ${480*scale},${cityY*scale}`);
            const groupPath = document.createElementNS(svgNS, 'path');
            groupPath.setAttribute('id', 'exportGroupPath');
            groupPath.setAttribute('d', `M ${20*scale},${groupY*scale} A ${230*scale},${baselineArch.groupArch*scale} 0 0,1 ${480*scale},${groupY*scale}`);
            defs.appendChild(cityPath);
            defs.appendChild(groupPath);
            svg.appendChild(defs);
            
            const cityTextEl = document.createElementNS(svgNS, 'text');
            cityTextEl.setAttribute('text-anchor', 'middle');
            cityTextEl.setAttribute('fill', style.color);
            cityTextEl.setAttribute('font-family', style.font);
            cityTextEl.setAttribute('font-weight', style.weight);
            cityTextEl.setAttribute('font-size', citySize * scale);
            cityTextEl.style.letterSpacing = (baselineArch.cityTrack * scale) + 'px';
            const cityTextPath = document.createElementNS(svgNS, 'textPath');
            cityTextPath.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#exportCityPath');
            cityTextPath.setAttribute('startOffset', '50%');
            cityTextPath.innerHTML = formatText(cityText, citySize * scale);
            cityTextEl.appendChild(cityTextPath);
            svg.appendChild(cityTextEl);
            
            const groupTextEl = document.createElementNS(svgNS, 'text');
            groupTextEl.setAttribute('text-anchor', 'middle');
            groupTextEl.setAttribute('fill', style.color);
            groupTextEl.setAttribute('font-family', style.font);
            groupTextEl.setAttribute('font-weight', style.weight);
            groupTextEl.setAttribute('font-size', groupSize * scale);
            groupTextEl.style.letterSpacing = (baselineArch.groupTrack * scale) + 'px';
            const groupTextPath = document.createElementNS(svgNS, 'textPath');
            groupTextPath.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#exportGroupPath');
            groupTextPath.setAttribute('startOffset', '50%');
            groupTextPath.innerHTML = formatText(groupText, groupSize * scale);
            groupTextEl.appendChild(groupTextPath);
            svg.appendChild(groupTextEl);
            
            const svgData = new XMLSerializer().serializeToString(svg);
            const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
            const svgUrl = URL.createObjectURL(svgBlob);
            const textImage = await loadImage(svgUrl);
            ctx.drawImage(textImage, 0, 0);
            URL.revokeObjectURL(svgUrl);
            
            return new Promise((resolve) => {
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/png', 0.95);
            });
            
        } catch (error) {
            console.error('PNG generation failed:', error);
            return null;
        }
    }
    
    function loadImage(src) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = src;
        });
    }
    
    async function handleCheckout() {
    // Validate selections
    if (!selectedStyle || !selectedProduct || !selectedColor || !selectedSize) {
        alert('Please select all options');
        return;
    }
    
    const checkoutBtn = document.getElementById('ctaButton');
    const originalText = checkoutBtn.textContent;
    checkoutBtn.textContent = 'Preparing design...';
    checkoutBtn.disabled = true;
    
    try {
        // VARIANT MAPPING
        const VARIANT_MAP = {
            'tee-black-s': { shopifyVariantId: '46057714417814', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_s_gco_black_gpr_4-0_gildan_64000' },
            'tee-black-m': { shopifyVariantId: '46057714548886', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_m_gco_black_gpr_4-0_gildan_64000' },
            'tee-black-l': { shopifyVariantId: '46057714516118', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_l_gco_black_gpr_4-0_gildan_64000' },
            'tee-black-xl': { shopifyVariantId: '46057714483350', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_xl_gco_black_gpr_4-0_gildan_64000' },
            'tee-black-2xl': { shopifyVariantId: '46057714450582', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_2xl_gco_black_gpr_4-0_gildan_64000' },
            'tee-white-s': { shopifyVariantId: '46057714581654', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_s_gco_white_gpr_4-0_gildan_64000' },
            'tee-white-m': { shopifyVariantId: '46057714712726', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_m_gco_white_gpr_4-0_gildan_64000' },
            'tee-white-l': { shopifyVariantId: '46057714679958', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_l_gco_white_gpr_4-0_gildan_64000' },
            'tee-white-xl': { shopifyVariantId: '46057714647190', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_xl_gco_white_gpr_4-0_gildan_64000' },
            'tee-white-2xl': { shopifyVariantId: '46057714614422', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_2xl_gco_white_gpr_4-0_gildan_64000' },
            'tee-navy-s': { shopifyVariantId: '46057714745494', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_s_gco_navy_gpr_4-0_gildan_64000' },
            'tee-navy-m': { shopifyVariantId: '46057714876566', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_m_gco_navy_gpr_4-0_gildan_64000' },
            'tee-navy-l': { shopifyVariantId: '46057714843798', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_l_gco_navy_gpr_4-0_gildan_64000' },
            'tee-navy-xl': { shopifyVariantId: '46057714811030', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_xl_gco_navy_gpr_4-0_gildan_64000' },
            'tee-navy-2xl': { shopifyVariantId: '46057714778262', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_2xl_gco_navy_gpr_4-0_gildan_64000' },
            'tee-gray-s': { shopifyVariantId: '46057714909334', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_s_gco_gray_gpr_4-0_gildan_64000' },
            'tee-gray-m': { shopifyVariantId: '46057715040406', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_m_gco_gray_gpr_4-0_gildan_64000' },
            'tee-gray-l': { shopifyVariantId: '46057715007638', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_l_gco_gray_gpr_4-0_gildan_64000' },
            'tee-gray-xl': { shopifyVariantId: '46057714974870', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_xl_gco_gray_gpr_4-0_gildan_64000' },
            'tee-gray-2xl': { shopifyVariantId: '46057714942102', gelatoUid: 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_2xl_gco_gray_gpr_4-0_gildan_64000' }
        };
        
        console.log('Starting checkout process...');
        
        // 1. Get SVG and clone it
        const svg = document.getElementById('previewSVG');
        if (!svg) {
            throw new Error('Design preview not found');
        }
        
        const svgClone = svg.cloneNode(true);
        
        // 2. CRITICAL FIX: Embed background image as base64
        checkoutBtn.textContent = 'Loading design elements...';
        
        const bgImage = svgClone.querySelector('#bgImage');
        if (bgImage && bgImage.href.baseVal) {
            const imageUrl = bgImage.href.baseVal;
            console.log('Loading background image:', imageUrl);
            
            // Load image and convert to base64
            const base64 = await new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    try {
                        // Draw to canvas to get base64
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        const dataUrl = canvas.toDataURL('image/png');
                        console.log('Background image converted to base64');
                        resolve(dataUrl);
                    } catch (err) {
                        reject(err);
                    }
                };
                
                img.onerror = () => reject(new Error('Failed to load background image'));
                img.src = imageUrl;
                
                setTimeout(() => reject(new Error('Background image load timeout')), 10000);
            });
            
            // Replace external URL with base64
            bgImage.setAttributeNS('http://www.w3.org/1999/xlink', 'href', base64);
            console.log('Background image embedded in SVG');
        }
        
        // Small delay for fonts
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // 3. Convert SVG (with embedded image) to PNG
        checkoutBtn.textContent = 'Converting design...';
        
        const svgData = new XMLSerializer().serializeToString(svgClone);
        const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(svgBlob);
        
        // Create image from SVG
        const img = new Image();
        
        const imageLoadPromise = new Promise((resolve, reject) => {
            img.onload = () => {
                console.log('SVG converted to image');
                resolve();
            };
            img.onerror = () => reject(new Error('Failed to convert SVG'));
            setTimeout(() => reject(new Error('SVG conversion timeout')), 10000);
        });
        
        img.src = url;
        await imageLoadPromise;
        
        // 4. Draw to high-res canvas
        const canvas = document.createElement('canvas');
        canvas.width = 9000;
        canvas.height = 7200;
        const ctx = canvas.getContext('2d');
        
        // Fill white background
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, 9000, 7200);
        
        // Calculate centered scaling
        const svgWidth = 500;
        const svgHeight = 400;
        const scale = Math.min(9000 / svgWidth, 7200 / svgHeight);
        const scaledWidth = svgWidth * scale;
        const scaledHeight = svgHeight * scale;
        const offsetX = (9000 - scaledWidth) / 2;
        const offsetY = (7200 - scaledHeight) / 2;
        
        // Draw SVG
        ctx.drawImage(img, offsetX, offsetY, scaledWidth, scaledHeight);
        
        URL.revokeObjectURL(url);
        
        console.log('Canvas created:', canvas.width, 'x', canvas.height);
        
        // 5. Convert to blob
        checkoutBtn.textContent = 'Generating PNG...';
        
        const blob = await new Promise((resolve, reject) => {
            canvas.toBlob((b) => {
                if (b) resolve(b);
                else reject(new Error('Failed to create PNG'));
            }, 'image/png', 1.0);
        });
        
        const sizeMB = (blob.size / 1024 / 1024).toFixed(2);
        console.log('PNG created, size:', sizeMB + 'MB');
        
        if (blob.size < 10000) {
            throw new Error('PNG file too small (' + sizeMB + 'MB) - design may not have rendered correctly');
        }
        
        // 6. Upload to Cloudinary
        checkoutBtn.textContent = 'Uploading design...';
        
        const formData = new FormData();
        formData.append('file', blob);
        formData.append('upload_preset', 'america250');
        formData.append('folder', 'usa250-orders');
        
        const cloudinaryResponse = await fetch(
            'https://api.cloudinary.com/v1_1/dqab444bd/image/upload',
            {
                method: 'POST',
                body: formData
            }
        );
        
        if (!cloudinaryResponse.ok) {
            const errorText = await cloudinaryResponse.text();
            throw new Error(`Upload failed: ${errorText}`);
        }
        
        const cloudinaryData = await cloudinaryResponse.json();
        const designUrl = cloudinaryData.secure_url;
        
        console.log('‚úì Design uploaded:', designUrl);
        console.log('‚úì Public ID:', cloudinaryData.public_id);
        
        // 7. Map variant
        const variantKey = `${selectedProduct}-${selectedColor}-${selectedSize}`.toLowerCase();
        const variant = VARIANT_MAP[variantKey];
        
        if (!variant) {
            throw new Error(`No variant found for: ${selectedProduct} / ${selectedColor} / ${selectedSize}`);
        }
        
        console.log('‚úì Variant found:', variantKey);
        
        // 8. Build Shopify URL
        checkoutBtn.textContent = 'Redirecting to checkout...';
        
        const shopifyUrl = new URL(`https://shop.4ship.ca/cart/${variant.shopifyVariantId}:1`);
        shopifyUrl.searchParams.append('attributes[design_url]', designUrl);
        shopifyUrl.searchParams.append('attributes[style]', selectedStyle);
        shopifyUrl.searchParams.append('attributes[city]', document.getElementById('cityInput').value || 'Custom Design');
        shopifyUrl.searchParams.append('attributes[group]', document.getElementById('groupInput').value || '');
        shopifyUrl.searchParams.append('attributes[gelato_product]', variant.gelatoUid);
        shopifyUrl.searchParams.append('attributes[gelato_template]', '45d4d937-e9bd-4ba3-83fe-1d7d965cce40');
        
        console.log('‚úì Redirecting to Shopify');
        
        // 9. Redirect
        window.location.href = shopifyUrl.toString();
        
    } catch (error) {
        console.error('‚úó Checkout error:', error);
        console.error('Stack:', error.stack);
        alert('Checkout failed: ' + error.message + '\n\nPlease try again or contact support.');
        checkoutBtn.textContent = originalText;
        checkoutBtn.disabled = false;
    }
}

    
    function init() {
        updateProgress();
        updateStepIndicator();
        initializeMockups();
        
        if (window.innerWidth >= 768) {
            document.querySelector('.style-cards').classList.add('hidden');
            document.querySelector('.style-cards-desktop').classList.remove('hidden');
            document.querySelector('.advanced-controls').classList.remove('hidden');
        }
    }
    
    window.addEventListener('load', init);

    // Final checkout function for v1.11 frontend
// Add this to your index.html or main.js

async function handleCheckout() {
    // Validate selections
    if (!selectedStyle || !selectedProduct || !selectedColor || !selectedSize) {
        alert('Please select all options');
        return;
    }
    
    const checkoutBtn = document.getElementById('checkoutBtn');
    checkoutBtn.textContent = 'Generating design...';
    checkoutBtn.disabled = true;
    
    try {
        // 1. Generate PNG from canvas
        const canvas = document.getElementById('canvas');
        const dataUrl = canvas.toDataURL('image/png');
        const blob = await (await fetch(dataUrl)).blob();
        
        console.log('Design generated, uploading to Cloudinary...');
        
        // 2. Upload to Cloudinary
        const formData = new FormData();
        formData.append('file', blob);
        formData.append('upload_preset', 'america250');
        
        const cloudinaryResponse = await fetch(
            'https://api.cloudinary.com/v1_1/dqab444bd/image/upload',
            {
                method: 'POST',
                body: formData
            }
        );
        
        if (!cloudinaryResponse.ok) {
            throw new Error('Cloudinary upload failed');
        }
        
        const cloudinaryData = await cloudinaryResponse.json();
        const designUrl = cloudinaryData.secure_url;
        
        console.log('Design uploaded:', designUrl);
        
        // 3. Map product selection to Shopify variant
        const variantKey = `${selectedProduct}-${selectedColor}-${selectedSize}`.toLowerCase();
        
        // TEMPORARY: For now, use placeholder variant ID
        // You'll replace this with your actual variant mapping
        const TEMP_VARIANT_ID = '46057714417814'; // Replace with your actual variant ID
        
        // Get Gelato product UID
        const GELATO_UIDS = {
            'tee-white-s': 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_s_gco_white_gpr_4-0_gildan_64000',
            'tee-white-m': 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_m_gco_white_gpr_4-0_gildan_64000',
            'tee-white-l': 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_l_gco_white_gpr_4-0_gildan_64000',
            'tee-white-xl': 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_xl_gco_white_gpr_4-0_gildan_64000',
            'tee-white-2xl': 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_2xl_gco_white_gpr_4-0_gildan_64000',
            'tee-black-s': 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_s_gco_black_gpr_4-0_gildan_64000',
            'tee-black-m': 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_m_gco_black_gpr_4-0_gildan_64000',
            'tee-black-l': 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_l_gco_black_gpr_4-0_gildan_64000',
            'tee-black-xl': 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_xl_gco_black_gpr_4-0_gildan_64000',
            'tee-black-2xl': 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_2xl_gco_black_gpr_4-0_gildan_64000',
            'tee-navy-s': 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_s_gco_navy_gpr_4-0_gildan_64000',
            'tee-navy-m': 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_m_gco_navy_gpr_4-0_gildan_64000',
            'tee-navy-l': 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_l_gco_navy_gpr_4-0_gildan_64000',
            'tee-navy-xl': 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_xl_gco_navy_gpr_4-0_gildan_64000',
            'tee-navy-2xl': 'apparel_product_gca_t-shirt_gsc_crewneck_gcu_unisex_gqa_classic_gsi_2xl_gco_navy_gpr_4-0_gildan_64000'
        };
        
        const gelatoUid = GELATO_UIDS[variantKey];
        if (!gelatoUid) {
            throw new Error(`No Gelato product for: ${variantKey}`);
        }
        
        // 4. Build Shopify cart URL
        const shopifyUrl = new URL(`https://shop-4ship-ca.myshopify.com/cart/${TEMP_VARIANT_ID}:1`);
        
        // Add custom attributes (these get passed to webhook)
        shopifyUrl.searchParams.append('attributes[design_url]', designUrl);
        shopifyUrl.searchParams.append('attributes[style]', selectedStyle);
        shopifyUrl.searchParams.append('attributes[city]', document.getElementById('cityInput').value);
        shopifyUrl.searchParams.append('attributes[group]', document.getElementById('groupInput').value || '');
        shopifyUrl.searchParams.append('attributes[gelato_product]', gelatoUid);
        shopifyUrl.searchParams.append('attributes[gelato_template]', '45d4d937-e9bd-4ba3-83fe-1d7d965cce40');
        
        console.log('Redirecting to Shopify:', shopifyUrl.toString());
        
        // 5. Redirect to Shopify
        window.location.href = shopifyUrl.toString();
        
    } catch (error) {
        console.error('Checkout error:', error);
        alert('Checkout failed: ' + error.message);
        checkoutBtn.textContent = 'Checkout';
        checkoutBtn.disabled = false;
    }
}

// SIMPLE NAVIGATION - Add to existing v1.13.1

// Navigation state
let navStep = 1;

// Show/hide sections based on step
function showSection(section) {
    // Hide all optional sections
    const styleSection = document.querySelector('.style-section');
    const previewSection = document.querySelector('.preview-section');
    const inputSections = document.querySelectorAll('.input-section');
    const colorSection = document.querySelector('.selector-section');
    const sizeSection = document.querySelectorAll('.selector-section')[1];
    
    // Step 1: Style selection only
    if (section === 'style') {
        if (styleSection) styleSection.style.display = 'block';
        if (previewSection) previewSection.style.display = 'none';
        inputSections.forEach(s => s.style.display = 'none');
        navStep = 1;
    }
    
    // Step 2: Text customization
    else if (section === 'text') {
        if (styleSection) styleSection.style.display = 'none';
        if (previewSection) previewSection.style.display = 'block';
        inputSections.forEach(s => s.style.display = 'block');
        if (colorSection) colorSection.style.display = 'none';
        if (sizeSection) sizeSection.style.display = 'none';
        navStep = 2;
    }
    
    // Step 3: Color/size selection
    else if (section === 'options') {
        if (styleSection) styleSection.style.display = 'none';
        if (previewSection) previewSection.style.display = 'block';
        inputSections.forEach(s => s.style.display = 'none');
        if (colorSection) colorSection.style.display = 'block';
        if (sizeSection) sizeSection.style.display = 'block';
        navStep = 3;
    }
    
    updateNavButtonsSimple();
}

// Simple back/next logic
function goBackSimple() {
    if (navStep === 2) {
        showSection('style');
    } else if (navStep === 3) {
        showSection('text');
    }
}

function goNextSimple() {
    if (navStep === 1 && selectedStyle) {
        showSection('text');
    } else if (navStep === 2 && document.getElementById('cityInput')?.value) {
        showSection('options');
    } else if (navStep === 3 && selectedColor && selectedSize) {
        handleCheckout();
    }
}

// Update nav buttons
function updateNavButtonsSimple() {
    const backBtn = document.getElementById('navBackBtn');
    const nextBtn = document.getElementById('navNextBtn');
    
    if (backBtn) {
        backBtn.style.display = navStep === 1 ? 'none' : 'inline-flex';
    }
    
    if (nextBtn) {
        let canProceed = false;
        let btnText = 'NEXT ‚Üí';
        
        if (navStep === 1) {
            canProceed = selectedStyle !== null;
        } else if (navStep === 2) {
            const cityValue = document.getElementById('cityInput')?.value || '';
            canProceed = cityValue.length > 0;
        } else if (navStep === 3) {
            canProceed = selectedColor !== null && selectedSize !== null;
            btnText = 'CONTINUE TO CHECKOUT ‚Üí';
        }
        
        nextBtn.disabled = !canProceed;
        nextBtn.textContent = btnText;
    }
    
    // Update progress
    const progressFill = document.querySelector('.progress-fill');
    if (progressFill) {
        const percent = (navStep / 3) * 100;
        progressFill.style.width = percent + '%';
    }
    
    const stepIndicator = document.querySelector('.step-indicator');
    if (stepIndicator) {
        const titles = ['Choose Style', 'Customize Text', 'Select Options'];
        stepIndicator.textContent = `Step ${navStep}/3: ${titles[navStep-1]}`;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    showSection('style');
    
    // Update nav when selections change
    const cityInput = document.getElementById('cityInput');
    if (cityInput) {
        cityInput.addEventListener('input', updateNavButtonsSimple);
    }
});

// Override selectCard to update nav
const originalSelectCard = window.selectCard;
window.selectCard = function(index) {
    if (originalSelectCard) originalSelectCard(index);
    updateNavButtonsSimple();
};

// Override selectColor/selectSize to update nav
const originalSelectColor = window.selectColor;
window.selectColor = function(color) {
    if (originalSelectColor) originalSelectColor(color);
    updateNavButtonsSimple();
};

const originalSelectSize = window.selectSize;
window.selectSize = function(size) {
    if (originalSelectSize) originalSelectSize(size);
    updateNavButtonsSimple();
};

</script>

</body>
</html>
